!function(){"use strict";resizer.init();const t=resizer.getGameHeight(),e=resizer.getGameWidth();let i,n=32,s=new E(-1*n,-1*n,n,n+10),r=null,o=null,a=document.getElementById("top-bar"),h=document.getElementById("pause-box"),c=document.getElementById("help-box"),u=document.getElementById("pause"),l=document.getElementById("help"),p=document.getElementById("pause-menu"),d=document.getElementById("resume"),f=document.getElementById("help-mini"),g=document.getElementById("help-menu"),m=document.getElementById("back"),y=document.getElementById("dimmer");function v(t){t.classList.remove("center-popin"),t.classList.add("center-popout"),y.classList.remove("partial-fade-out"),y.classList.add("partial-fade-in"),a.style.display="none"}function w(t,e){t.classList.remove("center-popout"),t.classList.add("center-popin"),t.addEventListener("animationend",function i(){e.classList.remove("center-popin"),e.classList.add("center-popout"),t.removeEventListener("animationend",i)},!1)}function b(t){return Math.floor(Math.random()*Math.floor(t))}function x(t,e){e>=t.length?console.error("ERROR: mutableRemoveIndex: index is out of range"):t.length<=0?console.error("ERROR: mutableRemoveIndex: empty array"):(t[e]=t[t.length-1],t[t.length-1]=void 0,t.length=t.length-1)}function k(t){this.template=t,this.pool=[]}function E(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}function L(t,e,i,n,s){this.width=e,this.height=i,this.frames=n,this.frameRate=s,this.timer=0,this.currentFrame=0,this.image=t,this.animationEndEvent=null,this.layers=[],this.draw=!0,this.foreground=!1,this.alpha=1,this.fadeAmt=0}function A(t,e,i,n,s){this.x=t,this.y=e,this.xFraction=0,this.yFraction=0,this.time=0,this.width=i,this.height=n,this.sprite=s,this.hitbox=new E(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}function I(t,e,i,n,s){A.call(this,t,e,i,n,s)}function R(t,e,i){let n=0,s=0;i&&(n=i.width,s=i.height),A.call(this,t,e,n,s,i),this.maxLife=3,this.life=this.maxLife}function B(t,e,i,n,s){let r=0,o=0;s&&(r=s.width,o=s.height),A.call(this,t,e,r,o,s),this.invisPointY=n,this.speed=i,this.isFake=!1,this.lane=1,this.triggeredWave=!1,this.triggeredPause=!1,this.clicked=!1}function F(t,e,i,n=!1){let s,r,o=this;if(this.buffer=null,this.audioContext=e,this.gainNode=i,this.loop=n,(s=document.createElement("audio")).canPlayType)if(s.canPlayType&&""!==s.canPlayType("audio/mp4"))t+=".mp4";else{if(!s.canPlayType||""===s.canPlayType('audio/ogg; codecs="vorbis"'))return void console.log("Error: MP4 and OGG files are unsupported on this device.");t+=".ogg"}(r=new XMLHttpRequest).open("GET",encodeURI(t),!0),r.responseType="arraybuffer",r.addEventListener("error",function(){console.log("Error loading from server: "+t)},!1),r.addEventListener("load",function(){e.decodeAudioData(r.response,function(t){o.buffer=t},function(t){console.log("Error decoding audio data: "+t.err)})},!1),r.send()}k.prototype.take=function(){let t,e,i=this.pool.length,n=null;for(e=0;e<i;e++)if((n=this.pool[e]).available)return n.available=!1,n.object.init(),n.object;return(t=this.template.clone()).init(),this.pool.push({available:!1,object:t}),t},k.prototype.putBack=function(t){let e,i,n=this.pool.length;for(i=0;i<n;i++)if((e=this.pool[i]).object===t)return void(e.available=!0)},E.prototype.left=function(){return this.x},E.prototype.right=function(){return this.x+this.width},E.prototype.top=function(){return this.y},E.prototype.bottom=function(){return this.y+this.height},E.prototype.intersects=function(t){return this.right()>=t.left()&&this.left()<=t.right()&&this.top()<=t.bottom()&&this.bottom()>=t.top()},E.prototype.contains=function(t,e){return this.left()<=t&&t<=this.right()&&this.bottom()<=e&&e<=this.top()},E.prototype.union=function(t){let e,i,n,s;if(void 0!==t)return e=Math.min(this.x,t.x),i=Math.min(this.y,t.y),n=Math.max(this.right(),t.right())-Math.min(this.left(),t.left()),s=Math.max(this.bottom(),t.bottom())-Math.min(this.top(),t.top()),this.x=e,this.y=i,this.width=n,this.height=s,this},E.prototype.intersection=function(t){let e,i,n,s;return e=Math.max(this.left(),t.left()),s=Math.min(this.bottom(),t.bottom()),i=Math.min(this.right(),t.right()),n=Math.max(this.top(),t.top()),e>i||s<n?(this.x=-1,this.y=-1,this.width=0,this.height=0):(this.x=e,this.y=n,this.width=i-e,this.height=s-n),this},E.prototype.getArea=function(){return this.height*this.width},L.prototype.eventDriven=function(t,e,i,n,s,r,o,a,h){let c=document.createElement("img"),u=document.createElement("img");return c.addEventListener("load",function t(){let o=document.createElement("canvas"),l=o.getContext("2d");o.width=e*r,o.height=i,l.drawImage(c,h*n,a*s,n*r,s,0,0,e*r,i),u.src=o.toDataURL("image/png"),c.removeEventListener("load",t)},!1),c.src=t,this.width=e,this.height=i,this.frames=r,this.frameRate=o,this.image=u,this},L.prototype.tiled=function(t,e,i,n,s,r,o,a,h){let c=document.createElement("img"),u=document.createElement("img");return c.addEventListener("load",function t(){let l,p,d=document.createElement("canvas"),f=d.getContext("2d");for(d.width=e,d.height=i,l=0;l<a;l++)for(p=0;p<h;p++)f.drawImage(c,o*n,r*s,n,s,l*e/a,p*i/h,e/a,i/h);u.src=d.toDataURL("image/png"),c.removeEventListener("load",t)},!1),c.src=t,this.width=e,this.height=i,this.frameRate=0,this.frames=1,this.image=u,this},L.prototype.resetAnimation=function(){this.currentFrame=0},L.prototype.update=function(t){let e;var i,n,s;for(this.alpha=(i=this.alpha+this.fadeAmt,n=0,s=1,Math.min(Math.max(i,n),s)),e=0;e<this.layers.length;e++)this.layers[e].update(t);this.frameRate>0&&(this.timer+=t,this.timer>1/this.frameRate&&(this.timer=0,this.currentFrame++,this.currentFrame>this.frames-1&&null!==this.animationEndEvent&&this.animationEndEvent()))},L.prototype.init=function(){this.width=0,this.height=0,this.frameRate=0,this.frames=0,this.currentFrame=0,this.timer=0,this.alpha=1,this.fadeAmt=0,this.layers.length=0,this.image=null,this.animationEndEvent=null,this.draw=!0,this.foreground=!1},L.prototype.clone=function(){return new L(this.image,this.width,this.height,this.frames,this.frameRate)},L.prototype.copyAttributes=function(t){return this.width=t.width,this.height=t.height,this.frameRate=t.frameRate,this.frames=t.frames,this.image=t.image,this.animationEndEvent=t.animationEndEvent,this.draw=t.draw,this.alpha=t.alpha,this.fadeAmt=t.fadeAmt,this.foreground=t.foreground,this},L.prototype.addLayer=function(t){this.layers.push(t)},A.prototype.init=function(){this.x=0,this.y=0,this.xFraction=0,this.yFraction=0,this.time=0,this.sprite=null},A.prototype.clone=function(){return new A(this.x,this.y,this.width,this.height,this.sprite)},A.prototype.update=function(t){let e=this.x,i=this.y,n=this.xFraction,s=this.yFraction;this.time+=t,e+=n,i+=s,e-=n=e%1,i-=s=i%1,this.x=e,this.y=i,this.xFraction=n,this.yFraction=s},A.prototype.collisionRect=function(){return this.hitbox.x=this.x,this.hitbox.y=this.y,this.hitbox.width=this.width,this.hitbox.height=this.height,this.hitbox},A.prototype.isCollidingWith=function(t){let e=this.collisionRect(),i=t.collisionRect();return e.intersects(i)},I.prototype=Object.create(A.prototype),I.prototype.init=function(){A.prototype.init.call(this)},I.prototype.clone=function(){return new I(this.x,this.y,this.width,this.height,this.sprite)},R.prototype=Object.create(A.prototype),R.prototype.update=function(t){A.prototype.update.call(this,t),P.addScore(1)},R.prototype.addLife=function(){this.life+=1,this.life>=this.maxLife&&(this.life=this.maxLife)},R.prototype.loseLife=function(){this.life-=1,this.life<=0&&P.setGameOver()},R.prototype.move=function(t,e){this.x=t,this.y=e},B.prototype=Object.create(A.prototype),B.prototype.init=function(){A.prototype.init.call(this),this.x=-100,this.y=-100,this.invisPointY=0,this.speed=0,this.lane=1,this.isFake=!1,this.triggeredWave=!1,this.triggeredPause=!1,this.clicked=!1},B.prototype.clone=function(){return new B(this.x,this.y,this.speed,this.invisPointY,this.sprite)},B.prototype.update=function(t){A.prototype.update.call(this,t),this.y+=this.speed},F.prototype.play=function(){let t=this;if(this.buffer){let t=this.audioContext.createBufferSource();t.buffer=this.buffer,t.connect(this.gainNode).connect(this.audioContext.destination),t.start(0),t.loop=this.loop}else window.setTimeout(function(){t.play()},50)};let _=function(){let i=new k(new L(null,0,0,0,0)),n=i.take().eventDriven("build/sprites/ghost.png",72,72,128,128,1,0,0,0),s=i.take().eventDriven("build/sprites/tap.png",90,90,64,64,2,3,0,0);s.animationEndEvent=s.resetAnimation;let r,o,a,h,c,u,l=i.take().tiled("build/sprites/grassland-tile.jpg",e,t,414,307,0,0,1,2),p=i.take().eventDriven("build/sprites/bigx.png",90,90,128,128,1,0,0,0),d=i.take().eventDriven("build/sprites/check.png",90,90,128,128,1,0,0,0),f=i.take().eventDriven("build/sprites/grave.png",90,90,128,128,1,0,0,0),g=t/2-t/4,m=i.take().eventDriven("build/sprites/fog.png",e,g,438,266,1,0,0,0);return r=new(window.AudioContext||window.webkitAudioContext),h=1,c=.1,u=.15,(o=r.createGain()).gain.value=c,(a=r.createGain()).gain.value=u,{spr_enemy:function(){return i.take().copyAttributes(n)},spr_tapIcon:function(){return i.take().copyAttributes(s)},spr_tiledGrass:function(){return i.take().copyAttributes(l)},spr_bigX:function(){return i.take().copyAttributes(p)},spr_check:function(){return i.take().copyAttributes(d)},spr_grave:function(){return i.take().copyAttributes(f)},spr_fog:function(){return i.take().copyAttributes(m)},snd_valid:new F("audio/ding",r,a),snd_error:new F("audio/error",r,a),snd_bgm:new F("audio/bgm",r,o,!0),initVolume:function(){let t;if("undefined"!=typeof Storage){try{t=JSON.parse(localStorage.getItem("nback_masterVolume"))}catch(t){console.log("Previous volume data is corrupted or missing.")}if(t||0===t)return h=t,this.setMasterVolume(t),t}return null},setMasterVolume:function(){if(h=vol,a.gain.value=u*vol,o.gain.value=c*vol,"undefined"!=typeof Storage)try{localStorage.setItem("nback_masterVolume",JSON.stringify(h))}catch(t){console.log("Error: an issue occurred when saving volume data.")}},putSpriteBack:function(t){let e;for(e=t.layers.length;e>=0;e--)i.putBack(t.layers[e]);i.putBack(t)}}}(),M=function(){const e=document.getElementById("bar-label"),i=document.getElementById("start-button");let n=resizer.getCanvas(),s=n.getContext("2d",{alpha:!1}),r=0,o=0,a=[];function h(t,e,i){let n,r=t.layers,o=t;for(n=0;n<=r.length;n++)t=r[n],n===r.length&&(t=o),t.draw&&(t.frameRate<=0||t.currentFrame>=t.frames)?(s.save(),s.globalAlpha=t.alpha,s.drawImage(t.image,t.width*(t.frames-1),0,t.width,t.height,e,i,t.width,t.height),s.restore()):t.draw&&(s.save(),s.globalAlpha=t.alpha,s.drawImage(t.image,t.width*t.currentFrame,0,t.width,t.height,e,i,t.width,t.height),s.restore())}let c=function(){let e=0,i=_.spr_tiledGrass();return function(){h(i,0,e-t),h(i,0,e),P.accelerating()&&!P.gameOver()&&(e=(e+20)%t)}}();return{render:function(t){let n,s,u=P.entities(),l=u.length;for(c(),function(t=!1){let n,s;P&&!P.started()?i.style.display="block":P&&(i.style.display="none",n=P.player().life,s=P.score(),(o!==s||t)&&(o=s,e.textContent="Score: "+s),(r!==n||t)&&(r=n))}(),s=0;s<l;s++)(n=u[s]).sprite&&((P.accelerating()||n instanceof I||0!==n.sprite.fadeAmt)&&n.sprite.update(t),n.sprite.foreground?a.push(n):h(n.sprite,n instanceof I?n.x+n.width/4:n.x,n.y));for(s=0;s<a.length;s++)h((n=a[s]).sprite,n.x,n.y);a.length=0},canvas:n}}(),P=function(){let i,n,s,r,o,a,h,c,u,l,p,d,f,g,m,y,v=new k(new I(0,0,0,0,null)),w=new k(new B(0,0,0,0,null)),E=20,L=t-t/5,F=t/4,P=t-t/3,S=!1,O=1,T=function(){const t=6;let i,n=[];for(i=0;i<t;i++)n.push(e*(i/t));return{NUM_LANES:t,getLaneByLocation:function(e){for(i=t;i>=0;i--)if(e>n[i])return i;return-1},getCenterX:function(t){return n[t]}}}(),C=function(){let i,n,s,r,o,a,h,c,u,l;return{init:function(){i=0,s=[],r=0,o=0,a=[],h=0,c=new A(-e,-t,0,0,_.spr_fog()),u=new A(-e,-t,0,0,_.spr_fog()),l=new A(-e,-t,0,0,_.spr_fog()),c.sprite.foreground=!0,u.sprite.foreground=!0,l.sprite.foreground=!0,z(c),z(u),z(l),n=2*t},updateWavesPassed:function(){r++},showTutorial:function(){if(h<a.length&&a[h].wave===r){let t;(t=v.take()).x=T.getCenterX(a[h++].lane),t.y=L,t.sprite=_.spr_tapIcon(),t.width=t.sprite.width,t.height=t.sprite.height,z(t)}},spawn:function(){let e,h,p,d,f=!1;switch(r){case 4:c.x=0,c.y=n-F+20,c.sprite.alpha=0,c.sprite.fadeAmt=.04;break;case 18:case 78:u.x=0,u.y=n-F+130,u.sprite.alpha=0,u.sprite.fadeAmt=.04;break;case 33:case 118:l.x=0,l.y=n-F+130,l.sprite.alpha=0,l.sprite.fadeAmt=.04;break;case 58:u.sprite.fadeAmt=-.04,l.sprite.fadeAmt=-.04}switch(o){case 0:case 1:case 2:f=!0;break;case 5:case 6:case 7:i=1,n=.75*t,f=!0;break;case 20:n=t/2;break;case 35:n=t/3;break;case 60:i=2,n=.75*t;break;case 80:n=t/2;break;case 130:n=t/3;break;case 200:i=3,n=.75*t;break;case 220:n=t/2;break;case 330:n=t/3;break;default:o>350&&(n=t/5)}for(p=b(T.NUM_LANES-i),d=0;d<=i;d++)(e=w.take()).lane=p+d,e.x=T.getCenterX(p+d),e.y=-10,e.speed=E,e.invisPointY=n,e.sprite=_.spr_grave(),e.width=e.sprite.width,e.height=e.sprite.width,e.isFake=!0,s[d]=e,z(e);h=s[b(s.length)],_.putSpriteBack(h.sprite),h.sprite=_.spr_enemy(),h.sprite.addLayer(_.spr_grave()),h.isFake=!1,h.sprite.draw=!0,f&&a.push({lane:h.lane,wave:o}),o++},wavesPassed:function(){return r}}}();function D(){c=!c}function G(){h=!h}function z(t){t instanceof R?o=t:t instanceof B&&s.push(t),i.push(t)}function N(t){let e,n=t.length;if(0!==n){for(e=n-1;e>=0;e--){let n,r=t[e];null!==r.sprite&&_.putSpriteBack(r.sprite),(n=i.indexOf(r))>=0&&x(i,n),(n=s.indexOf(r))>=0&&(x(s,n),w.putBack(r)),r instanceof I&&v.putBack(r)}t.includes(o)&&(o=void 0)}}function W(){l=!l}let j=function(){const t=1500;let e,i=!1,n=0,s=3;function r(){O=1,n=0,s=3,i=!1,console.log("Multiplier reset to 1.")}return{start:function(){i=!0,e=window.setTimeout(r,t)},stop:function(){i&&(window.clearTimeout(e),i=!1,1==(n=(n+1)%s)&&(s+=2,O+=.5))},reset:r}}();return{start:function(){if(i&&N(i),i=[],s=[],r=[],n=[],p=!1,h=!0,c=!1,u=!1,l=!1,g=0,m=0,a=0,C.init(),"undefined"!=typeof Storage){try{y=JSON.parse(localStorage.getItem("nback_scores"))}catch(t){y=[]}null===y&&(y=[])}z(o=new R(-100,-100,null)),C.spawn(),S||(S=!0,d=this.update.bind(this),f&&window.cancelAnimationFrame(f),window.requestAnimationFrame(d))},update:function(e){let s,o,l,g=!1,m=i.length,y=Math.min((e-a)/1e3,.05);if(a=e,p)return M.render(y),S=!1,void(f=window.requestAnimationFrame(d));for(l=0;l<m;l++)o=(s=i[l]).invisPointY-F,h&&s.update(y),s instanceof B&&s.y>=P&&!s.clicked&&r.indexOf(s)<0&&r.push(s),s.y>t?(n.push(s),s instanceof B&&!s.isFake&&c&&D()):s instanceof B&&!s.isFake&&s.y>=o&&s.y<s.invisPointY?s.sprite.alpha=1-(s.y-o)/(s.invisPointY-o):s instanceof B&&!s.isFake&&s.y>=s.invisPointY&&!s.clicked&&(s.sprite.draw=!1),s instanceof B&&!s.isFake&&s.y>=F&&!s.triggeredWave&&(C.spawn(),s.triggeredWave=!0),h&&!c&&s instanceof B&&s.y>=L&&!s.triggeredPause&&(g=!0,s.triggeredPause=!0),u&&s instanceof I&&n.push(s);g&&(G(),D(),C.showTutorial(),W(),j.start()),u&&(u=!1),N(n),n.length=0,M.render(y),window.requestAnimationFrame(d)},setGameOver:function(){var t;p||(p=!0,t=Math.round(g),y.push(t),y.sort(function(t,e){return e-t}),y=y.slice(0,10),"undefined"!=typeof Storage&&localStorage.setItem("nback_scores",JSON.stringify(y)))},addScore:function(t){(m=(g+=t*O+m)%1)>0&&(g-=m)},toggleAcceleration:G,toggleInputBuffer:D,setInputEventFired:function(){u=!0},lanes:T,addEntity:z,clickZone:P,updateWavesPassed:C.updateWavesPassed,toggleInput:W,inputTimer:j,easyAccuracy:!1,stoppingThreshold:L,inputEnabled:function(){return l},accelerating:function(){return h},inputBuffered:function(){return c},started:function(){return S},gameOver:function(){return p},entities:function(){return i},enemies:function(){return s},player:function(){return o},frontRowEnemies:function(){return r},score:function(){return g}}}();function S(t){if(!P.started())return;let e,i,r,o,a=P.clickZone,h=null,c=P.frontRowEnemies(),u=P.player(),l=c.length,p=0,d=0;if("touchstart"===t.type?e=resizer.getRelativeEventCoords(t.changedTouches[0]):"mousedown"===t.type&&(e=resizer.getRelativeEventCoords(t)),!P.gameOver()&&u&&P.inputEnabled()&&e.y>=a){for(s.x=e.x-n/2,s.y=e.y-n/2,P.easyAccuracy&&(s.x=P.lanes.getCenterX(P.lanes.getLaneByLocation(e.x)),s.y=P.stoppingThreshold,s.height=64,s.width=1),r=0;r<l;r++)(p=(o=(i=c[r]).collisionRect()).intersection(s).getArea())>d&&(d=p,i.clicked=!0,h=i);d>0&&(P.toggleInput(),_.putSpriteBack(h.sprite),h.isFake?(h.sprite=_.spr_bigX(),u.loseLife(),P.inputTimer.reset(),_.snd_error.play()):(h.sprite=_.spr_check(),u.addLife(),P.inputTimer.stop(),_.snd_valid.play()),P.setInputEventFired(),P.accelerating()?P.inputBuffered()||P.toggleInputBuffer():P.toggleAcceleration(),c.length=0,P.updateWavesPassed())}}M.canvas.addEventListener("touchstart",function(t){"mousedown"===r?Date.now()-o>1e3&&(r=t.type,o=Date.now(),S(t)):(r=t.type,o=Date.now(),S(t))}),M.canvas.addEventListener("mousedown",function(t){"touchstart"===r?Date.now()-o>1e3&&(r=t.type,o=Date.now(),S(t)):(r=t.type,o=Date.now(),S(t))}),document.getElementById("start-button").addEventListener("click",function(){P.start()}),document.body.addEventListener("touchmove",function(t){t.preventDefault()},{passive:!1}),resizer.addResizeEvent(function(){let t,e;e=a.style.display,a.style.display="",t=a.clientHeight,a.style.display=e,i=1.2*t,h.style.height=i+"px",h.style.width=i+"px",c.style.height=i+"px",c.style.width=i+"px"}),resizer.resize(),u.addEventListener("click",function(){v(p)},!1),d.addEventListener("click",function(){var t;(t=p).classList.remove("center-popout"),t.classList.add("center-popin"),y.classList.remove("partial-fade-in"),y.classList.add("partial-fade-out"),a.style.display=""},!1),f.addEventListener("click",function(){w(p,g)},!1),l.addEventListener("click",function(){v(g)},!1),m.addEventListener("click",function(){w(g,p)},!1)}();