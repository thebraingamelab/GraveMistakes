!function(){"use strict";function t(t){return Math.floor(Math.random()*Math.floor(t))}function e(t,e){e>=t.length?console.error("ERROR: mutableRemoveIndex: index is out of range"):t.length<=0?console.error("ERROR: mutableRemoveIndex: empty array"):(t[e]=t[t.length-1],t[t.length-1]=void 0,t.length=t.length-1)}function i(t){this.template=t,this.pool=[]}function n(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}function o(t,e,i,n,o){this.width=e,this.height=i,this.frames=n,this.frameRate=o,this.timer=0,this.currentFrame=0,this.image=t,this.animationEndEvent=null}function r(t,e,i,o,r){this.x=t,this.y=e,this.time=0,this.draw=!0,this.width=i,this.height=o,this.sprite=r,this.hitbox=new n(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}function s(t,e,i,n,o){r.call(this,t,e,i,n,o)}function h(t,e,i){r.call(this,t,e,40,40,i),this.rangeOfMovement=4,this.maxLife=75,this.life=this.maxLife}function a(t,e,i,n,o){r.call(this,t,e,40,40,o),this.invisPointY=n,this.speed=i,this.isFake=!1,this.lane=1,this.triggeredWave=!1,this.triggeredPause=!1}let u,c,l;i.prototype.take=function(){let t,e;for(e=0;e<this.pool.length;e++)if(this.pool[e].available)return this.pool[e].available=!1,this.pool[e].object.init(),this.pool[e].object;return(t=this.template.clone()).init(),this.pool.push({available:!1,object:t}),t},i.prototype.putBack=function(t){let e;for(e=0;e<this.pool.length;e++)if(this.pool[e].object===t){this.pool[e].available=!0;break}},n.prototype.left=function(){return this.x},n.prototype.right=function(){return this.x+this.width},n.prototype.top=function(){return this.y},n.prototype.bottom=function(){return this.y+this.height},n.prototype.intersects=function(t){return this.right()>=t.left()&&this.left()<=t.right()&&this.top()<=t.bottom()&&this.bottom()>=t.top()},n.prototype.contains=function(t,e){return this.left()<=t&&t<=this.right()&&this.bottom()<=e&&e<=this.top()},n.prototype.union=function(t){let e,i,n,o;void 0!==t&&(e=Math.min(this.x,t.x),i=Math.min(this.y,t.y),n=Math.max(this.right(),t.right())-Math.min(this.left(),t.left()),o=Math.max(this.bottom(),t.bottom())-Math.min(this.top(),t.top()),this.x=e,this.y=i,this.width=n,this.height=o)},o.prototype.eventDriven=function(t,e,i,n,o,r,s,h,a){let u=document.createElement("img"),c=document.createElement("img");return u.addEventListener("load",function t(){let s=document.createElement("canvas"),l=s.getContext("2d");s.width=e*r,s.height=i,l.drawImage(u,a*n,h*o,n*r,o,0,0,e*r,i),c.src=s.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frames=r,this.frameRate=s,this.timer=0,this.currentFrame=0,this.image=c,this.animationEndEvent=null,this},o.prototype.tiled=function(t,e,i,n,o,r,s,h,a){let u=document.createElement("img"),c=document.createElement("img");return u.addEventListener("load",function t(){let l,p,f=document.createElement("canvas"),d=f.getContext("2d");for(f.width=e,f.height=i,l=0;l<h;l++)for(p=0;p<a;p++)d.drawImage(u,s*n,r*o,n,o,l*e/h,p*i/a,e/h,i/a);c.src=f.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frameRate=0,this.frames=1,this.timer=0,this.currentFrame=0,this.image=c,this},o.prototype.resetAnimation=function(){this.currentFrame=0},o.prototype.update=function(t){this.frameRate>0&&(this.timer+=t,this.timer>1/this.frameRate&&(this.timer=0,this.currentFrame++,this.currentFrame>this.frames-1&&null!==this.animationEndEvent&&this.animationEndEvent()))},o.prototype.init=function(){this.width=0,this.height=0,this.frameRate=0,this.frames=0,this.currentFrame=0,this.timer=0,this.image=null,this.animationEndEvent=null},o.prototype.clone=function(){return new o(this.image,this.width,this.height,this.frames,this.frameRate)},o.prototype.copyAttributes=function(t){return this.width=t.width,this.height=t.height,this.frameRate=t.frameRate,this.frames=t.frames,this.image=t.image,this.animationEndEvent=t.animationEndEvent,this},r.prototype.init=function(){this.x=0,this.y=0,this.time=0,this.draw=!0,this.sprite=null},r.prototype.clone=function(){return new r(this.x,this.y,this.width,this.height,this.sprite)},r.prototype.update=function(t){this.time+=t},r.prototype.collisionRect=function(){return this.hitbox.x=this.x,this.hitbox.y=this.y,this.hitbox.width=this.width,this.hitbox.height=this.height,this.hitbox},r.prototype.collisionLine=function(){return this.hitbox.x=this.x-this.width/2,this.hitbox.y=this.y-this.height/2,this.hitbox.width=this.width,this.hitbox.height=1,this.hitbox},r.prototype.isCollidingWith=function(t){let e=this.collisionRect(),i=t.collisionRect();return e.intersects(i)},s.prototype=Object.create(r.prototype),s.prototype.init=function(){r.prototype.init.call(this)},s.prototype.clone=function(){return new s(this.x,this.y,this.width,this.height,this.sprite)},h.prototype=Object.create(r.prototype),h.prototype.update=function(t){r.prototype.update.call(this,t),c.addScore(1)},h.prototype.addLife=function(){this.life+=25,this.life>=this.maxLife&&(this.life=this.maxLife)},h.prototype.loseLife=function(){this.life-=25,this.life<=0&&c.setGameOver()},h.prototype.move=function(t,e){this.x=t,this.y=e},a.prototype=Object.create(r.prototype),a.prototype.init=function(){r.prototype.init.call(this),this.invisPointY=0,this.speed=0,this.lane=1,this.isFake=!1,this.triggeredWave=!1,this.triggeredPause=!1},a.prototype.clone=function(){return new a(this.x,this.y,this.speed,this.invisPointY,this.sprite)},a.prototype.update=function(t){r.prototype.update.call(this,t),this.y+=this.speed};const p=720,f=480;l=function(){let t=new i(new o(null,0,0,0,0)),e=t.take().eventDriven("build/sprites/animals.png",60,60,26,36,1,0,4,7),n=t.take().eventDriven("build/sprites/explosion.png",60,60,223,174,21,21,0,0),r=t.take().eventDriven("build/sprites/tap.png",75,76,75,76,2,3,0,0);r.animationEndEvent=r.resetAnimation;let s=t.take().tiled("build/sprites/grassland.png",f,p,128,128,4,6,4,10),h=t.take().eventDriven("build/sprites/bigx.png",45,60,239,299,1,0,0,0);return{spr_enemy:function(){return t.take().copyAttributes(e)},spr_explosion:function(){return t.take().copyAttributes(n)},spr_tapIcon:function(){return t.take().copyAttributes(r)},spr_tiledGrass:function(){return t.take().copyAttributes(s)},spr_bigX:function(){return t.take().copyAttributes(h)},putSpriteBack:function(e){t.putBack(e)}}}(),u=function(){let t=document.querySelector("#gameWindow"),e=t.getContext("2d"),i=p,n=f;function o(){const e=f/p,o=navigator.userAgent.toLowerCase(),r=o.indexOf("android")>-1,s=o.indexOf("iphone")>-1||o.indexOf("ipad")>-1;let h=document.querySelector(".container");i=window.innerHeight,n=i*e,(r||s)&&(document.body.style.height=window.innerHeight+50+"px"),t.style.width=n+"px",t.style.height=i+"px",h.style.width=n+"px",h.style.height=i+"px",window.setTimeout(function(){window.scrollTo(0,1)},1)}function r(t,i,n){t.frameRate<=0||t.currentFrame>=t.frames?e.drawImage(t.image,t.width*(t.frames-1),0,t.width,t.height,i,n,t.width,t.height):e.drawImage(t.image,t.width*t.currentFrame,0,t.width,t.height,i,n,t.width,t.height)}t.width=f,t.height=p,o(),window.addEventListener("resize",function(t,e,i){let n;return function(){let o=this,r=arguments,s=i&&!n;clearTimeout(n),n=setTimeout(function(){n=null,i||t.apply(o,r)},e),s&&t.apply(o,r)}}(o,250,!1),!1);let h=function(){let t=0,e=l.spr_tiledGrass();return function(){r(e,0,t-p),r(e,0,t),c.accelerating()&&!c.gameOver()&&(t+=20),t>=p&&(t=0)}}();return{render:function(t){let i,n,o=c.entities();for(h(),n=0;n<o.length;n++)i=o[n],e.fillStyle="#FF0000",null!==d&&e.fillRect(d.x,d.y,d.width,d.height),(c.accelerating()||i instanceof s)&&i.sprite.update(t),i.draw&&r(i.sprite,i.x,i.y-i.height/2)},GAME_FIELD_WIDTH:f,GAME_FIELD_HEIGHT:p,canvas:t,currentWidth:function(){return n}}}(),c=function(){let n,o,r,c,d,g,m,y,w,v,x,b,E,k,L,F=new i(new s(0,0,0,0,null)),R=new i(new a(0,0,0,0,null)),A=p-p/5,_=p/4,I=0,S=!1,O=!0,P=2*p,M=document.querySelector("#start_button"),B=function(){const t=6;let e,i=[];for(e=1;e<=t;e++)i.push(f*(e/t));return{NUM_LANES:t,getLaneByLocation:function(n){for(e=0;e<t;e++)if(n<i[e])return e;return-1},getCenterX:function(e){return f/t*e+20}}}(),D=function(){let e=1;return function(){let i,n,o,r;for(3===I&&(P=p/2),P>=80&&(P-=1),I%20==0&&(e+=I/20),o=t(B.NUM_LANES-e),r=0;r<=e&&e<=B.NUM_LANES;r++)(i=R.take()).lane=o+r,i.x=B.getCenterX(o+r),i.y=-10,i.speed=20,i.invisPointY=P,i.sprite=l.spr_enemy(),i.draw=!1,i.isFake=!0,i.triggeredWave=!1,i.triggeredPause=!1,c[r]=i,T(i);return(n=c[t(c.length)]).isFake=!1,n.draw=!0,n.lane}}();function N(){y=!y}function W(){m=!m}function T(t){t instanceof h?d=t:t instanceof a&&r.push(t),n.push(t)}function C(t){let i;if(0!==t.length){for(i=0;i<t.length;i++){let o,h=t[i];null!==h.sprite&&l.putSpriteBack(h.sprite),(o=n.indexOf(h))>=0&&e(n,o),(o=r.indexOf(h))>=0&&(e(r,o),R.putBack(h)),h instanceof s&&F.putBack(h)}t.includes(d)&&(d=void 0)}}return{start:function(){if(n&&C(n),n=[],r=[],c=[],o=[],x=[],I=0,v=!1,m=!0,y=!1,w=!1,k=0,g=0,P=2*p,M.style.display="none","undefined"!=typeof Storage)try{L=JSON.parse(localStorage.nBackScores)}catch(t){L=[]}d=new h(-100,-100,null),x.push(D()),S||(S=!0,b=this.update.bind(this),E&&window.cancelAnimationFrame(E),window.requestAnimationFrame(b))},update:function(t){let e,i,r,h=!1,c=Math.min((t-g)/1e3,.05);if(g=t,v)return S=!1,u.render(c),void(E=window.requestAnimationFrame(b));for(r=0;r<n.length;r++){if(i=(e=n[r]).invisPointY-_,m&&e.update(c),e.y>p?(o.push(e),e instanceof a&&!e.isFake&&(I++,y&&N())):e instanceof a&&e.isFake&&e.y>=i&&e.y<e.invisPointY?e.draw=!e.draw:e instanceof a&&e.isFake&&e.y>=e.invisPointY&&(e.draw=!0),O){let t;0<=I&&I<=2&&m&&!y&&e instanceof a&&e.y>=A&&!e.triggeredPause?(h=!0,e.triggeredPause=!0,(t=F.take()).x=B.getCenterX(x[I]),t.y=.75*p,t.sprite=l.spr_tapIcon(),t.width=t.sprite.width,t.height=t.sprite.height,T(t)):I>=3&&(O=!1)}else m&&!y&&e instanceof a&&e.y>=A&&!e.triggeredPause&&(h=!0,e.triggeredPause=!0);if(e instanceof a&&!e.isFake&&e.y>=_&&!e.triggeredWave){let t=D();e.triggeredWave=!0,O&&x.push(t)}w&&e instanceof s&&o.push(e)}h&&(W(),N()),w&&(w=!1),C(o),o.length=0,u.render(c),window.requestAnimationFrame(b)},setGameOver:function(){var t;v||(v=!0,M.style.display="block",t=Math.round(k),L.push(t),L.sort(function(t,e){return e-t}),L=L.slice(0,10),"undefined"!=typeof Storage&&(localStorage.nBackScores=JSON.stringify(L)),console.log(L))},addScore:function(t){k+=t},toggleAcceleration:W,toggleInputBuffer:N,setInputEventFired:function(){w=!0},lanes:B,addEntity:T,accelerating:function(){return m},inputBuffered:function(){return y},gameOver:function(){return v},entities:function(){return n},enemies:function(){return r},player:function(){return d}}}();let d=new n(-20,-20,20,20),g=p-p/3;function m(t){let e=u.currentWidth()/f;return{x:(t.pageX-function(t){let e=0;do{isNaN(t.offsetLeft)||(e+=t.offsetLeft),t=t.offsetParent}while(null!==t);return e}(u.canvas))/e,y:(t.pageY-function(t){let e=0;do{isNaN(t.offsetTop)||(e+=t.offsetTop),t=t.offsetParent}while(null!==t);return e}(u.canvas))/e}}u.canvas.addEventListener("click",function(t){let e,i,n=m(t),o=c.player();if(t.preventDefault(),t.stopImmediatePropagation(),!c.gameOver()&&o&&n.y>=g)for(d.x=n.x-5,d.y=n.y-5,e=0;e<c.enemies().length;e++)(i=c.enemies()[e]).draw&&i.collisionRect().intersects(d)&&(i.isFake?(i.sprite=l.spr_bigX(),o.loseLife()):(i.sprite=l.spr_explosion(),o.addLife()),c.setInputEventFired(),c.accelerating()?c.inputBuffered()||c.toggleInputBuffer():c.toggleAcceleration())}),u.canvas.addEventListener("touchstart",function(t){let e,i,n,o=t.changedTouches,r=c.player();for(t.preventDefault(),t.stopImmediatePropagation(),i=m(o[o.length-1]),n=o.length-1;n>=0&&!c.gameOver()&&r;n--)for(i=m(o[n]),d.x=i.x-5,d.y=i.y-5,n=0;n<c.enemies().length&&i.y>=g;n++)(e=c.enemies()[n]).draw&&e.collisionRect().intersects(d)&&(e.isFake?(e.sprite=l.spr_bigX(),r.loseLife()):(e.sprite=l.spr_explosion(),r.addLife()),c.setInputEventFired(),c.accelerating()?c.inputBuffered()||c.toggleInputBuffer():c.toggleAcceleration())}),document.querySelector("#start_button").addEventListener("click",function(){c.start()})}();