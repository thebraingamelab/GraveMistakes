!function(){"use strict";function t(t,e){e>=t.length?console.error("ERROR: mutableRemoveIndex: index is out of range"):t.length<=0?console.error("ERROR: mutableRemoveIndex: empty array"):(t[e]=t[t.length-1],t[t.length-1]=void 0,t.length=t.length-1)}function e(t){this.template=t,this.pool=[]}function i(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}function n(t,e,i,n,o){this.width=e,this.height=i,this.frames=n,this.frameRate=o,this.timer=0,this.currentFrame=0,this.image=t,this.animationEndEvent=null}function o(t,e,n,o,r){this.x=t,this.y=e,this.time=0,this.draw=!0,this.width=n,this.height=o,this.sprite=r,this.hitbox=new i(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}function r(t,e,i,n,r){o.call(this,t,e,i,n,r)}function s(t,e,i){o.call(this,t,e,40,40,i),this.rangeOfMovement=4,this.maxLife=75,this.life=this.maxLife}function h(t,e,i,n,r){o.call(this,t,e,40,10,r),this.invisPointY=n,this.speed=i,this.disappeared=!1}let a,u,p;e.prototype.take=function(){let t,e;for(e=0;e<this.pool.length;e++)if(this.pool[e].available)return this.pool[e].available=!1,this.pool[e].object.init(),this.pool[e].object;return(t=this.template.clone()).init(),this.pool.push({available:!1,object:t}),t},e.prototype.putBack=function(t){let e;for(e=0;e<this.pool.length;e++)if(this.pool[e].object===t){this.pool[e].available=!0;break}},i.prototype.left=function(){return this.x},i.prototype.right=function(){return this.x+this.width},i.prototype.top=function(){return this.y},i.prototype.bottom=function(){return this.y+this.height},i.prototype.intersects=function(t){return this.right()>=t.left()&&this.left()<=t.right()&&this.top()<=t.bottom()&&this.bottom()>=t.top()},i.prototype.union=function(t){let e,i,n,o;void 0!==t&&(e=Math.min(this.x,t.x),i=Math.min(this.y,t.y),n=Math.max(this.right(),t.right())-Math.min(this.left(),t.left()),o=Math.max(this.bottom(),t.bottom())-Math.min(this.top(),t.top()),this.x=e,this.y=i,this.width=n,this.height=o)},n.prototype.eventDriven=function(t,e,i,n,o,r,s,h,a){let u=document.createElement("img"),p=document.createElement("img");return u.addEventListener("load",function t(){let s=document.createElement("canvas"),c=s.getContext("2d");s.width=e*r,s.height=i,c.drawImage(u,a*n,h*o,n*r,o,0,0,e*r,i),p.src=s.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frames=r,this.frameRate=s,this.timer=0,this.currentFrame=0,this.image=p,this.animationEndEvent=null,this},n.prototype.tiled=function(t,e,i,n,o,r,s,h,a){let u=document.createElement("img"),p=document.createElement("img");return u.addEventListener("load",function t(){let c,l,f=document.createElement("canvas"),d=f.getContext("2d");for(f.width=e,f.height=i,c=0;c<h;c++)for(l=0;l<a;l++)d.drawImage(u,s*n,r*o,n,o,c*e/h,l*i/a,e/h,i/a);p.src=f.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frameRate=0,this.frames=1,this.timer=0,this.currentFrame=0,this.image=p,this},n.prototype.resetAnimation=function(){this.currentFrame=0},n.prototype.update=function(t){this.frameRate>0&&(this.timer+=t,this.timer>1/this.frameRate&&(this.timer=0,this.currentFrame++,this.currentFrame>this.frames-1&&null!==this.animationEndEvent&&this.animationEndEvent()))},n.prototype.init=function(){this.width=0,this.height=0,this.frameRate=0,this.frames=0,this.currentFrame=0,this.timer=0,this.image=null,this.animationEndEvent=null},n.prototype.clone=function(){return new n(this.image,this.width,this.height,this.frames,this.frameRate)},n.prototype.copyAttributes=function(t){return this.width=t.width,this.height=t.height,this.frameRate=t.frameRate,this.frames=t.frames,this.image=t.image,this.animationEndEvent=t.animationEndEvent,this},o.prototype.init=function(){this.x=0,this.y=0,this.time=0,this.draw=!0,this.sprite=null},o.prototype.clone=function(){return new o(this.x,this.y,this.width,this.height,this.sprite)},o.prototype.update=function(t){this.time+=t},o.prototype.collisionRect=function(){return this.hitbox.x=this.x-this.width/2,this.hitbox.y=this.y-this.height/2,this.hitbox.width=this.width,this.hitbox.height=this.height,this.hitbox},o.prototype.collisionLine=function(){return this.hitbox.x=this.x-this.width/2,this.hitbox.y=this.y-this.height/2,this.hitbox.width=this.width,this.hitbox.height=1,this.hitbox},r.prototype=Object.create(o.prototype),r.prototype.init=function(){o.prototype.init.call(this)},r.prototype.clone=function(){return new r(this.x,this.y,this.width,this.height,this.sprite)},s.prototype=Object.create(o.prototype),s.prototype.update=function(t){o.prototype.update.call(this,t),u.addScore(1)},s.prototype.addLife=function(){this.life+=25,this.life>=this.maxLife&&(this.life=this.maxLife)},s.prototype.loseLife=function(){this.life-=25,this.life<=0&&u.setGameOver()},s.prototype.move=function(t){this.x=u.lanes.getCenterX(t)},h.prototype=Object.create(o.prototype),h.prototype.init=function(){o.prototype.init.call(this),this.invisPointY=0,this.speed=0,this.disappeared=!1},h.prototype.clone=function(){return new h(this.x,this.y,this.speed,this.invisPointY,this.sprite)},h.prototype.update=function(t){o.prototype.update.call(this,t),this.y+=this.speed};const c=720,l=480;function f(t){let e=a.currentWidth()/l;return{x:(t.pageX-function(t){let e=0;do{isNaN(t.offsetLeft)||(e+=t.offsetLeft),t=t.offsetParent}while(null!==t);return e}(a.canvas))/e,y:(t.pageY-function(t){let e=0;do{isNaN(t.offsetTop)||(e+=t.offsetTop),t=t.offsetParent}while(null!==t);return e}(a.canvas))/e}}p=function(){let t=new e(new n(null,0,0,0,0)),i=t.take().eventDriven("build/sprites/animals.png",60,60,26,37,2,6,3,3);i.animationEndEvent=i.resetAnimation;let o=t.take().eventDriven("build/sprites/animals.png",60,60,26,36,1,0,4,7),r=t.take().eventDriven("build/sprites/explosion.png",60,60,223,174,21,21,0,0),s=t.take().tiled("build/sprites/grassland.png",l,60,128,128,15,4,6,1),h=t.take().eventDriven("build/sprites/tap.png",75,76,75,76,2,3,0,0);h.animationEndEvent=h.resetAnimation;let a=t.take().tiled("build/sprites/grassland.png",l,c,128,128,4,6,4,10);return{spr_playerWalkingUp:function(){return t.take().copyAttributes(i)},spr_enemy:function(){return t.take().copyAttributes(o)},spr_explosion:function(){return t.take().copyAttributes(r)},spr_leafPile:function(){return t.take().copyAttributes(s)},spr_tapIcon:function(){return t.take().copyAttributes(h)},spr_tiledGrass:function(){return t.take().copyAttributes(a)},putSpriteBack:function(e){t.putBack(e)}}}(),a=function(){let t=document.querySelector("#gameWindow"),e=t.getContext("2d"),i=c,n=l;function o(){const e=l/c,o=navigator.userAgent.toLowerCase(),r=o.indexOf("android")>-1,s=o.indexOf("iphone")>-1||o.indexOf("ipad")>-1;let h=document.querySelector(".container");i=window.innerHeight,n=i*e,(r||s)&&(document.body.style.height=window.innerHeight+50+"px"),t.style.width=n+"px",t.style.height=i+"px",h.style.width=n+"px",h.style.height=i+"px",window.setTimeout(function(){window.scrollTo(0,1)},1)}function s(t,i,n){t.frameRate<=0||t.currentFrame>=t.frames?e.drawImage(t.image,t.width*(t.frames-1),0,t.width,t.height,i,n,t.width,t.height):e.drawImage(t.image,t.width*t.currentFrame,0,t.width,t.height,i,n,t.width,t.height)}t.width=l,t.height=c,o(),window.addEventListener("resize",function(t,e,i){let n;return function(){let o=this,r=arguments,s=i&&!n;clearTimeout(n),n=setTimeout(function(){n=null,i||t.apply(o,r)},e),s&&t.apply(o,r)}}(o,250,!1),!1);let a=function(){let t=0,e=p.spr_tiledGrass();return function(){s(e,0,t-c),s(e,0,t),u.accelerating()&&!u.gameOver()&&(t+=6),t>=c&&(t=0)}}();return{render:function(t){let e,i,n=u.entities();for(a(),i=0;i<n.length;i++)e=n[i],(u.accelerating()||e instanceof r)&&e.sprite.update(t),e.draw&&e instanceof h&&e.disappeared?s(e.sprite,0,e.y-e.height/2):e.draw&&s(e.sprite,e.x,e.y-e.height/2)},GAME_FIELD_WIDTH:l,GAME_FIELD_HEIGHT:c,canvas:t,currentWidth:function(){return n}}}(),u=function(){let i,n,o,u,f,d,m,g,y,w,v,x,b,E={NUM_LANES:4,getNumber:function(t){let e;for(e=1;e<=this.NUM_LANES;e++)if(t<l*(e/this.NUM_LANES))return e;return-1},getCenterX:function(t){return l/this.NUM_LANES*(t-1)+20},randomLane:function(){return t=this.NUM_LANES,Math.floor(Math.random()*Math.floor(t))+1;var t}},L=new e(new r(0,0,0,0,null)),k=new e(new h(0,0,0,0,null)),A=6,_=!1,R=0,S=!1,I=!0,M=2*c,N=document.querySelector("#start_button");function O(){let t,e;return 3===R&&(M=c/2),M>=80&&(M-=5),e=E.getCenterX(E.randomLane()),(t=k.take()).x=e,t.y=-10,t.speed=A,t.invisPointY=M,t.sprite=p.spr_enemy(),t.disappeared=!1,D(t),e}function F(){d=!d}function B(){_=!_}function D(t){i.push(t),t instanceof s?u=t:t instanceof h&&o.push(t)}function P(e){let n;if(0!==e.length){for(n=0;n<e.length;n++){let s,h=e[n];null!==h.sprite&&p.putSpriteBack(h.sprite),(s=i.indexOf(h))>=0&&t(i,s),(s=o.indexOf(h))>=0&&(t(o,s),k.putBack(h),R++),h instanceof r&&L.putBack(h)}e.includes(u)&&(u=void 0)}}function T(t,e){let i=t.collisionLine(),n=e.collisionLine();return i.intersects(n)}return{start:function(){if(i&&P(i),i=[],o=[],n=[],y=[],R=-1,g=!1,_=!1,d=!0,m=!1,x=0,f=0,M=2*c,N.style.display="none","undefined"!=typeof Storage)try{b=JSON.parse(localStorage.nBackScores)}catch(t){b=[]}D(new s(E.getCenterX(1),c-60,p.spr_playerWalkingUp())),y.push(O()),S||(S=!0,w=this.update.bind(this),v&&window.cancelAnimationFrame(v),window.requestAnimationFrame(w))},update:function(t){let e,o,s,l=u.y-1.5*u.height,x=c/4,b=Math.min((t-f)/1e3,.05);if(f=t,g)return S=!1,a.render(b),void(v=window.requestAnimationFrame(w));for(s=0;s<i.length;s++){if(o=(e=i[s]).invisPointY-x,_&&e.update(b),e.y>c?(n.push(e),e instanceof h&&(u.loseLife(),d&&F())):e instanceof h&&T(e,u)?(u.addLife(),n.push(e),d&&F()):e instanceof h&&e.y>=o&&e.y<e.invisPointY?e.draw=!e.draw:e instanceof h&&e.y>=e.invisPointY&&e.y<e.invisPointY+e.speed&&(e.sprite=p.spr_leafPile(),e.draw=!0,e.disappeared=!0),I)if(-1<=R&&R<=2){let t;-1===R?((t=L.take()).x=y[++R],t.y=.75*c,t.sprite=p.spr_tapIcon(),t.width=t.sprite.width,t.height=t.sprite.height,D(t)):_&&!d&&e instanceof h&&e.y>=l&&e.y<l+e.speed&&(B(),F(),(t=L.take()).x=y[R],t.y=.75*c,t.sprite=p.spr_tapIcon(),t.width=t.sprite.width,t.height=t.sprite.height,D(t))}else R>=3&&(I=!1);else _&&!d&&e instanceof h&&e.y>=l&&e.y<l+e.speed&&(B(),F());if(e instanceof h&&e.y>=x&&e.y<x+e.speed){let t=O();I&&y.push(t)}m&&e instanceof r&&n.push(e)}m&&(m=!1),P(n),n.length=0,a.render(b),window.requestAnimationFrame(w)},setGameOver:function(){var t;g||(g=!0,u.sprite=p.spr_explosion(),N.style.display="block",t=Math.round(x),b.push(t),b.sort(function(t,e){return e-t}),b=b.slice(0,10),"undefined"!=typeof Storage&&(localStorage.nBackScores=JSON.stringify(b)),console.log(b))},addScore:function(t){x+=t},toggleAcceleration:B,toggleInputBuffer:F,setInputEventFired:function(){m=!0},lanes:E,accelerating:function(){return _},inputBuffered:function(){return d},gameOver:function(){return g},entities:function(){return i},enemies:function(){return o},player:function(){return u}}}(),a.canvas.addEventListener("click",function(t){let e=f(t),i=u.player();t.preventDefault(),!u.gameOver()&&i&&(i.move(u.lanes.getNumber(e.x)),u.setInputEventFired(),u.accelerating()?u.inputBuffered()||u.toggleInputBuffer():u.toggleAcceleration())}),a.canvas.addEventListener("touchstart",function(t){let e,i=t.changedTouches,n=u.player();if(t.preventDefault(),!u.gameOver()&&n)for(let t=i.length-1;t>=0;t--)e=f(i[t]),n.move(u.lanes.getNumber(e.x)),u.setInputEventFired(),u.accelerating()?u.inputBuffered()||u.toggleInputBuffer():u.toggleAcceleration()}),document.querySelector("#start_button").addEventListener("click",function(){u.start()})}();