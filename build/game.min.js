!function(){"use strict";function t(t){return Math.floor(Math.random()*Math.floor(t))}function e(t,e){e>=t.length?console.error("ERROR: mutableRemoveIndex: index is out of range"):t.length<=0?console.error("ERROR: mutableRemoveIndex: empty array"):(t[e]=t[t.length-1],t[t.length-1]=void 0,t.length=t.length-1)}function i(t){this.template=t,this.pool=[]}function n(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}function s(t,e,i,n,s){this.width=e,this.height=i,this.frames=n,this.frameRate=s,this.timer=0,this.currentFrame=0,this.image=t,this.animationEndEvent=null}function o(t,e,i,s,o){this.x=t,this.y=e,this.time=0,this.draw=!0,this.width=i,this.height=s,this.sprite=o,this.hitbox=new n(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}function r(t,e,i,n,s){o.call(this,t,e,i,n,s)}function a(t,e,i){o.call(this,t,e,40,40,i),this.rangeOfMovement=4,this.maxLife=3,this.life=this.maxLife}function h(t,e,i,n,s){o.call(this,t,e,40,40,s),this.invisPointY=n,this.speed=i,this.isFake=!1,this.lane=1,this.triggeredWave=!1,this.triggeredPause=!1}function l(t,e){let i;for(this.channel=0,this.channelList=[t],i=1;i<e;i++)this.channelList.push(t.cloneNode(!0))}let u,c,d;i.prototype.take=function(){let t,e,i=this.pool.length,n=null;for(e=0;e<i;e++)if((n=this.pool[e]).available)return n.available=!1,n.object.init(),n.object;return(t=this.template.clone()).init(),this.pool.push({available:!1,object:t}),t},i.prototype.putBack=function(t){let e,i,n=this.pool.length;for(i=0;i<n;i++)if((e=this.pool[i]).object===t)return void(e.available=!0)},n.prototype.left=function(){return this.x},n.prototype.right=function(){return this.x+this.width},n.prototype.top=function(){return this.y},n.prototype.bottom=function(){return this.y+this.height},n.prototype.intersects=function(t){return this.right()>=t.left()&&this.left()<=t.right()&&this.top()<=t.bottom()&&this.bottom()>=t.top()},n.prototype.contains=function(t,e){return this.left()<=t&&t<=this.right()&&this.bottom()<=e&&e<=this.top()},n.prototype.union=function(t){let e,i,n,s;void 0!==t&&(e=Math.min(this.x,t.x),i=Math.min(this.y,t.y),n=Math.max(this.right(),t.right())-Math.min(this.left(),t.left()),s=Math.max(this.bottom(),t.bottom())-Math.min(this.top(),t.top()),this.x=e,this.y=i,this.width=n,this.height=s)},s.prototype.eventDriven=function(t,e,i,n,s,o,r,a,h){let l=document.createElement("img"),u=document.createElement("img");return l.addEventListener("load",function t(){let r=document.createElement("canvas"),c=r.getContext("2d");r.width=e*o,r.height=i,c.drawImage(l,h*n,a*s,n*o,s,0,0,e*o,i),u.src=r.toDataURL("image/png"),l.removeEventListener("load",t)},!1),l.src=t,this.width=e,this.height=i,this.frames=o,this.frameRate=r,this.timer=0,this.currentFrame=0,this.image=u,this.animationEndEvent=null,this},s.prototype.tiled=function(t,e,i,n,s,o,r,a,h){let l=document.createElement("img"),u=document.createElement("img");return l.addEventListener("load",function t(){let c,d,p=document.createElement("canvas"),f=p.getContext("2d");for(p.width=e,p.height=i,c=0;c<a;c++)for(d=0;d<h;d++)f.drawImage(l,r*n,o*s,n,s,c*e/a,d*i/h,e/a,i/h);u.src=p.toDataURL("image/png"),l.removeEventListener("load",t)},!1),l.src=t,this.width=e,this.height=i,this.frameRate=0,this.frames=1,this.timer=0,this.currentFrame=0,this.image=u,this},s.prototype.resetAnimation=function(){this.currentFrame=0},s.prototype.update=function(t){this.frameRate>0&&(this.timer+=t,this.timer>1/this.frameRate&&(this.timer=0,this.currentFrame++,this.currentFrame>this.frames-1&&null!==this.animationEndEvent&&this.animationEndEvent()))},s.prototype.init=function(){this.width=0,this.height=0,this.frameRate=0,this.frames=0,this.currentFrame=0,this.timer=0,this.image=null,this.animationEndEvent=null},s.prototype.clone=function(){return new s(this.image,this.width,this.height,this.frames,this.frameRate)},s.prototype.copyAttributes=function(t){return this.width=t.width,this.height=t.height,this.frameRate=t.frameRate,this.frames=t.frames,this.image=t.image,this.animationEndEvent=t.animationEndEvent,this},o.prototype.init=function(){this.x=0,this.y=0,this.time=0,this.draw=!0,this.sprite=null},o.prototype.clone=function(){return new o(this.x,this.y,this.width,this.height,this.sprite)},o.prototype.update=function(t){this.time+=t},o.prototype.collisionRect=function(){return this.hitbox.x=this.x,this.hitbox.y=this.y,this.hitbox.width=this.width,this.hitbox.height=this.height,this.hitbox},o.prototype.collisionLine=function(){return this.hitbox.x=this.x-this.width/2,this.hitbox.y=this.y-this.height/2,this.hitbox.width=this.width,this.hitbox.height=1,this.hitbox},o.prototype.isCollidingWith=function(t){let e=this.collisionRect(),i=t.collisionRect();return e.intersects(i)},r.prototype=Object.create(o.prototype),r.prototype.init=function(){o.prototype.init.call(this)},r.prototype.clone=function(){return new r(this.x,this.y,this.width,this.height,this.sprite)},a.prototype=Object.create(o.prototype),a.prototype.update=function(t){o.prototype.update.call(this,t),c.addScore(1)},a.prototype.addLife=function(){this.life+=1,this.life>=this.maxLife&&(this.life=this.maxLife)},a.prototype.loseLife=function(){this.life-=1,this.life<=0&&c.setGameOver()},a.prototype.move=function(t,e){this.x=t,this.y=e},h.prototype=Object.create(o.prototype),h.prototype.init=function(){o.prototype.init.call(this),this.invisPointY=0,this.speed=0,this.lane=1,this.isFake=!1,this.triggeredWave=!1,this.triggeredPause=!1},h.prototype.clone=function(){return new h(this.x,this.y,this.speed,this.invisPointY,this.sprite)},h.prototype.update=function(t){o.prototype.update.call(this,t),this.y+=this.speed},l.prototype.play=function(){this.channelList[this.channel].play(),this.channel=(this.channel+1)%this.channelList.length},l.prototype.setVolume=function(t){let e;for(e=0;e<this.channelList.length;e++)this.channelList[e].volume=t};const p=720,f=480;d=function(){let t=new i(new s(null,0,0,0,0)),e=t.take().eventDriven("build/sprites/cat.png",65,54,197,162,1,0,0,0),n=t.take().eventDriven("build/sprites/explosion.png",51,51,223,174,21,21,0,0),o=t.take().eventDriven("build/sprites/tap.png",75,76,75,76,2,3,0,0);o.animationEndEvent=o.resetAnimation;let r=t.take().tiled("build/sprites/grassland.png",f,p,128,128,0,0,4,10),a=t.take().eventDriven("build/sprites/bigx.png",45,60,239,299,1,0,0,0),h=t.take().eventDriven("build/sprites/collar.png",128,128,1024,1024,1,0,0,0),u=new l(document.getElementById("valid"),4);u.setVolume(.2);let c=new l(document.getElementById("error"),4);c.setVolume(.2);let d=document.getElementById("bgm");return d.loop=!0,d.volume=.05,{spr_enemy:function(){return t.take().copyAttributes(e)},spr_explosion:function(){return t.take().copyAttributes(n)},spr_tapIcon:function(){return t.take().copyAttributes(o)},spr_tiledGrass:function(){return t.take().copyAttributes(r)},spr_bigX:function(){return t.take().copyAttributes(a)},spr_collar:function(){return t.take().copyAttributes(h)},snd_valid:u,snd_error:c,snd_bgm:d,putSpriteBack:function(e){t.putBack(e)}}}(),u=function(){let t,e=0,i=document.getElementById("start_button"),n=document.getElementById("gameWindow"),s=n.getContext("2d"),o=p,a=f;function h(){let e=f/p;const i=navigator.userAgent.toLowerCase();i.indexOf("android"),i.indexOf("iphone")>-1||i.indexOf("ipad");let s=document.getElementById("container");o=window.innerHeight,a=o*e,t&&(t.style.visibility="hidden"),(t=document.getElementById("overlay")).style.visibility="visible",a>window.innerWidth&&(e=p/f,a=window.innerWidth,o=a*e,t.style.visibility="hidden",(t=document.getElementById("widebar")).style.visibility="visible",t.style.height=window.innerHeight-o+"px"),n.style.width=a+"px",n.style.height=o+"px",s.style.width=a+"px",s.style.height=o+"px",s.style.marginLeft="-"+a/2+"px",window.setTimeout(function(){window.scrollTo(0,1)},1)}function l(t,e,i){t.frameRate<=0||t.currentFrame>=t.frames?s.drawImage(t.image,t.width*(t.frames-1),0,t.width,t.height,e,i,t.width,t.height):s.drawImage(t.image,t.width*t.currentFrame,0,t.width,t.height,e,i,t.width,t.height)}n.width=f,n.height=p,h(),window.addEventListener("resize",function(t,e,i){let n;return function(){let s=this,o=arguments,r=i&&!n;clearTimeout(n),n=setTimeout(function(){n=null,i||t.apply(s,o)},e),r&&t.apply(s,o)}}(h,250,!1),!1);let u=function(){let t=0,e=d.spr_tiledGrass();return function(){l(e,0,t-p),l(e,0,t),c.accelerating()&&!c.gameOver()&&(t+=20),t>=p&&(t=0)}}();return{render:function(n){let s,o,a=c.entities(),h=a.length;for(u(),function(){let n,s=c.player().life;if(c.started()?c.started()&&(i.style.display="none"):i.style.display="block",e!==s){for(e=s;t.hasChildNodes();)t.removeChild(t.firstChild);for(n=0;n<s;n++){let e=document.createElement("img");e.src=d.spr_collar().image.src,e.className="life",t.appendChild(e)}}}(),o=0;o<h;o++)s=a[o],(c.accelerating()||s instanceof r)&&s.sprite.update(n),s.draw&&s instanceof r?l(s.sprite,s.x,s.y):s.draw&&l(s.sprite,s.x-s.width/4,s.y-s.height/2)},GAME_FIELD_WIDTH:f,GAME_FIELD_HEIGHT:p,canvas:n,currentWidth:function(){return a}}}(),c=function(){let n,s,o,l,c,m,g,y,w,v,b,x,E,k,L,F=new i(new r(0,0,0,0,null)),R=new i(new h(0,0,0,0,null)),_=20,I=p-p/5,B=p/4,P=p-p/3,A=!1,O=!0,D=function(){const t=6;let e,i=[];for(e=1;e<=t;e++)i.push(f*(e/t));return{NUM_LANES:t,getLaneByLocation:function(n){for(e=0;e<t;e++)if(n<i[e])return e;return-1},getCenterX:function(e){return f/t*e+20}}}(),M=function(){let e,i,n,s;return{init:function(){e=0,n=0,s=[],i=2*p},spawn:function(){let o,r,a,h;switch(n){case 5:e=1,i=.75*p;break;case 20:i=p/2;break;case 35:i=p/3;break;case 80:e=2,i=.75*p;break;case 100:i=p/2;break;case 140:i=p/3;break;case 220:e=3,i=.75*p;break;case 240:i=p/2;break;case 350:i=p/3;break;default:n>350&&(i=p/5)}for(a=t(D.NUM_LANES-e),h=0;h<=e;h++)(o=R.take()).lane=a+h,o.x=D.getCenterX(a+h),o.y=-10,o.speed=_,o.invisPointY=i,o.sprite=d.spr_enemy(),o.draw=!1,o.isFake=!0,o.triggeredWave=!1,o.triggeredPause=!1,s[h]=o,N(o);return(r=s[t(s.length)]).isFake=!1,r.draw=!0,r.lane},updateWavesPassed:function(){n++},wavesPassed:function(){return n}}}();function W(){y=!y}function S(){g=!g}function N(t){t instanceof a?c=t:t instanceof h&&o.push(t),n.push(t)}function C(t){let i,s=t.length;if(0!==s){for(i=s-1;i>=0;i--){let s,a=t[i];null!==a.sprite&&d.putSpriteBack(a.sprite),(s=n.indexOf(a))>=0&&e(n,s),(s=o.indexOf(a))>=0&&(e(o,s),R.putBack(a)),a instanceof r&&F.putBack(a)}t.includes(c)&&(c=void 0)}}return{start:function(){if(n&&C(n),n=[],o=[],l=[],s=[],b=[],v=!1,g=!0,y=!1,w=!1,k=0,m=0,M.init(),"undefined"!=typeof Storage)try{L=JSON.parse(localStorage.nBackScores)}catch(t){L=[]}d.snd_bgm.play(),c=new a(-100,-100,null),b.push(M.spawn()),A||(A=!0,x=this.update.bind(this),E&&window.cancelAnimationFrame(E),window.requestAnimationFrame(x))},update:function(t){let e,i,o,a=!1,c=M.wavesPassed(),f=n.length,k=Math.min((t-m)/1e3,.05);if(m=t,v)return A=!1,u.render(k),void(E=window.requestAnimationFrame(x));for(o=0;o<f;o++){if(i=(e=n[o]).invisPointY-B,g&&e.update(k),e instanceof h&&e.y>=P&&l.indexOf(e)<0&&l.push(e),e.y>p?(s.push(e),e instanceof h&&!e.isFake&&y&&W()):e instanceof h&&e.isFake&&e.y>=i&&e.y<e.invisPointY?e.draw=!e.draw:e instanceof h&&e.isFake&&e.y>=e.invisPointY&&(e.draw=!0),O){let t;0<=c&&c<=2&&g&&!y&&e instanceof h&&e.y>=I&&!e.triggeredPause?(a=!0,e.triggeredPause=!0,(t=F.take()).x=D.getCenterX(b[c]),t.y=I,t.sprite=d.spr_tapIcon(),t.width=t.sprite.width,t.height=t.sprite.height,N(t)):c>=3&&(O=!1)}else g&&!y&&e instanceof h&&e.y>=I&&!e.triggeredPause&&(a=!0,e.triggeredPause=!0);if(e instanceof h&&!e.isFake&&e.y>=B&&!e.triggeredWave){let t=M.spawn();e.triggeredWave=!0,O&&b.push(t)}w&&e instanceof r&&s.push(e)}a&&(S(),W()),w&&(w=!1),C(s),s.length=0,u.render(k),window.requestAnimationFrame(x)},setGameOver:function(){var t;v||(v=!0,t=Math.round(k),L.push(t),L.sort(function(t,e){return e-t}),L=L.slice(0,10),"undefined"!=typeof Storage&&(localStorage.nBackScores=JSON.stringify(L)),console.log(L))},addScore:function(t){k+=t},toggleAcceleration:S,toggleInputBuffer:W,setInputEventFired:function(){w=!0},lanes:D,addEntity:N,clickZone:P,updateWavesPassed:M.updateWavesPassed,accelerating:function(){return g},inputBuffered:function(){return y},started:function(){return A},gameOver:function(){return v},entities:function(){return n},enemies:function(){return o},player:function(){return c},frontRowEnemies:function(){return l}}}();let m=40,g=new n(-1*m,-1*m,m,m+10),y=null,w=null;function v(t){let e,i,n,s=c.clickZone,o=c.frontRowEnemies(),r=c.player(),a=o.length;if("touchstart"===t.type?e=b(t.changedTouches[0]):"mousedown"===t.type&&(e=b(t)),!c.gameOver()&&r&&e.y>=s)for(g.x=e.x-m/2,g.y=e.y-m/2,n=0;n<a;n++)if((i=o[n]).draw&&i.collisionRect().intersects(g))return i.isFake?(i.sprite=d.spr_bigX(),r.loseLife(),d.snd_error.play()):(i.sprite=d.spr_explosion(),r.addLife(),d.snd_valid.play()),c.setInputEventFired(),c.accelerating()?c.inputBuffered()||c.toggleInputBuffer():c.toggleAcceleration(),o.length=0,void c.updateWavesPassed()}function b(t){let e=u.currentWidth()/f;return{x:(t.pageX-function(t){let e=0;do{isNaN(t.offsetLeft)||(e+=t.offsetLeft),t=t.offsetParent}while(null!==t);return e}(u.canvas))/e,y:(t.pageY-function(t){let e=0;do{isNaN(t.offsetTop)||(e+=t.offsetTop),t=t.offsetParent}while(null!==t);return e}(u.canvas))/e}}u.canvas.addEventListener("touchstart",function(t){"mousedown"===y?Date.now()-w>1e3&&(y=t.type,w=Date.now(),v(t)):(y=t.type,w=Date.now(),v(t))}),u.canvas.addEventListener("mousedown",function(t){"touchstart"===y?Date.now()-w>1e3&&(y=t.type,w=Date.now(),v(t)):(y=t.type,w=Date.now(),v(t))}),document.getElementById("start_button").addEventListener("click",function(){c.start()})}();