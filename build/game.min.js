!function(){"use strict";function t(t){return Math.floor(Math.random()*Math.floor(t))}function e(t,e){e>=t.length?console.error("ERROR: mutableRemoveIndex: index is out of range"):t.length<=0?console.error("ERROR: mutableRemoveIndex: empty array"):(t[e]=t[t.length-1],t[t.length-1]=void 0,t.length=t.length-1)}function i(t){this.template=t,this.pool=[]}function n(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}function o(t,e,i,n,o){this.width=e,this.height=i,this.frames=n,this.frameRate=o,this.timer=0,this.currentFrame=0,this.image=t,this.animationEndEvent=null,this.layers=[]}function r(t,e,i,o,r){this.x=t,this.y=e,this.time=0,this.draw=!0,this.width=i,this.height=o,this.sprite=r,this.hitbox=new n(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}function s(t,e,i,n,o){r.call(this,t,e,i,n,o)}function a(t,e,i){let n=0,o=0;i&&(n=i.width,o=i.height),r.call(this,t,e,n,o,i),this.maxLife=3,this.life=this.maxLife}function h(t,e,i,n,o){let s=0,a=0;o&&(s=o.width,a=o.height),r.call(this,t,e,s,a,o),this.invisPointY=n,this.speed=i,this.isFake=!1,this.lane=1,this.triggeredWave=!1,this.triggeredPause=!1,this.clicked=!1}function u(t,e,i,n=!1){let o,r,s=this;if(this.buffer=null,this.audioContext=e,this.gainNode=i,this.loop=n,(o=document.createElement("audio")).canPlayType)if(o.canPlayType&&""!==o.canPlayType("audio/mp4"))t+=".mp4";else{if(!o.canPlayType||""===o.canPlayType('audio/ogg; codecs="vorbis"'))return void console.log("Error: MP4 and OGG files are unsupported on this device.");t+=".ogg"}(r=new XMLHttpRequest).open("GET",encodeURI(t),!0),r.responseType="arraybuffer",r.addEventListener("error",function(){console.log("Error loading from server: "+t)},!1),r.addEventListener("load",function(){e.decodeAudioData(r.response,function(t){s.buffer=t},function(t){console.log("Error decoding audio data: "+t.err)})},!1),r.send()}let l,c,d;i.prototype.take=function(){let t,e,i=this.pool.length,n=null;for(e=0;e<i;e++)if((n=this.pool[e]).available)return n.available=!1,n.object.init(),n.object;return(t=this.template.clone()).init(),this.pool.push({available:!1,object:t}),t},i.prototype.putBack=function(t){let e,i,n=this.pool.length;for(i=0;i<n;i++)if((e=this.pool[i]).object===t)return void(e.available=!0)},n.prototype.left=function(){return this.x},n.prototype.right=function(){return this.x+this.width},n.prototype.top=function(){return this.y},n.prototype.bottom=function(){return this.y+this.height},n.prototype.intersects=function(t){return this.right()>=t.left()&&this.left()<=t.right()&&this.top()<=t.bottom()&&this.bottom()>=t.top()},n.prototype.contains=function(t,e){return this.left()<=t&&t<=this.right()&&this.bottom()<=e&&e<=this.top()},n.prototype.union=function(t){let e,i,n,o;if(void 0!==t)return e=Math.min(this.x,t.x),i=Math.min(this.y,t.y),n=Math.max(this.right(),t.right())-Math.min(this.left(),t.left()),o=Math.max(this.bottom(),t.bottom())-Math.min(this.top(),t.top()),this.x=e,this.y=i,this.width=n,this.height=o,this},n.prototype.intersection=function(t){let e,i,n,o;return e=Math.max(this.left(),t.left()),o=Math.min(this.bottom(),t.bottom()),i=Math.min(this.right(),t.right()),n=Math.max(this.top(),t.top()),e>i||o<n?(this.x=-1,this.y=-1,this.width=0,this.height=0):(this.x=e,this.y=n,this.width=i-e,this.height=o-n),this},n.prototype.getArea=function(){return this.height*this.width},o.prototype.eventDriven=function(t,e,i,n,o,r,s,a,h){let u=document.createElement("img"),l=document.createElement("img");return u.addEventListener("load",function t(){let s=document.createElement("canvas"),c=s.getContext("2d");s.width=e*r,s.height=i,c.drawImage(u,h*n,a*o,n*r,o,0,0,e*r,i),l.src=s.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frames=r,this.frameRate=s,this.timer=0,this.currentFrame=0,this.image=l,this.animationEndEvent=null,this},o.prototype.tiled=function(t,e,i,n,o,r,s,a,h){let u=document.createElement("img"),l=document.createElement("img");return u.addEventListener("load",function t(){let c,d,p=document.createElement("canvas"),f=p.getContext("2d");for(p.width=e,p.height=i,c=0;c<a;c++)for(d=0;d<h;d++)f.drawImage(u,s*n,r*o,n,o,c*e/a,d*i/h,e/a,i/h);l.src=p.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frameRate=0,this.frames=1,this.timer=0,this.currentFrame=0,this.image=l,this},o.prototype.resetAnimation=function(){this.currentFrame=0},o.prototype.update=function(t){let e;for(e=0;e<this.layers.length;e++)this.layers[e].update(t);this.frameRate>0&&(this.timer+=t,this.timer>1/this.frameRate&&(this.timer=0,this.currentFrame++,this.currentFrame>this.frames-1&&null!==this.animationEndEvent&&this.animationEndEvent()))},o.prototype.init=function(){this.width=0,this.height=0,this.frameRate=0,this.frames=0,this.currentFrame=0,this.timer=0,this.image=null,this.animationEndEvent=null},o.prototype.clone=function(){return new o(this.image,this.width,this.height,this.frames,this.frameRate)},o.prototype.copyAttributes=function(t){return this.width=t.width,this.height=t.height,this.frameRate=t.frameRate,this.frames=t.frames,this.image=t.image,this.animationEndEvent=t.animationEndEvent,this},o.prototype.addLayer=function(t){this.layers.push(t)},r.prototype.init=function(){this.x=0,this.y=0,this.time=0,this.draw=!0,this.sprite=null},r.prototype.clone=function(){return new r(this.x,this.y,this.width,this.height,this.sprite)},r.prototype.update=function(t){this.time+=t},r.prototype.collisionRect=function(){return this.hitbox.x=this.x,this.hitbox.y=this.y,this.hitbox.width=this.width,this.hitbox.height=this.height,this.hitbox},r.prototype.isCollidingWith=function(t){let e=this.collisionRect(),i=t.collisionRect();return e.intersects(i)},s.prototype=Object.create(r.prototype),s.prototype.init=function(){r.prototype.init.call(this)},s.prototype.clone=function(){return new s(this.x,this.y,this.width,this.height,this.sprite)},a.prototype=Object.create(r.prototype),a.prototype.update=function(t){r.prototype.update.call(this,t),c.addScore(1)},a.prototype.addLife=function(){this.life+=1,this.life>=this.maxLife&&(this.life=this.maxLife)},a.prototype.loseLife=function(){this.life-=1,this.life<=0&&c.setGameOver()},a.prototype.move=function(t,e){this.x=t,this.y=e},h.prototype=Object.create(r.prototype),h.prototype.init=function(){r.prototype.init.call(this),this.invisPointY=0,this.speed=0,this.lane=1,this.isFake=!1,this.triggeredWave=!1,this.triggeredPause=!1,this.clicked=!1},h.prototype.clone=function(){return new h(this.x,this.y,this.speed,this.invisPointY,this.sprite)},h.prototype.update=function(t){r.prototype.update.call(this,t),this.y+=this.speed},u.prototype.play=function(){let t=this;if(this.buffer){let t=this.audioContext.createBufferSource();t.buffer=this.buffer,t.connect(this.gainNode).connect(this.audioContext.destination),t.start(0),t.loop=this.loop}else window.setTimeout(function(){t.play()},50)};const p=960,f=540;d=function(){let t=new i(new o(null,0,0,0,0)),e=t.take().eventDriven("build/sprites/ghost.png",72,72,128,128,1,0,0,0),n=t.take().eventDriven("build/sprites/tap.png",90,90,64,64,2,3,0,0);n.animationEndEvent=n.resetAnimation;let r,s,a,h,l,c,d=t.take().eventDriven("build/sprites/grassland-real.jpg",f,p,414,896,1,0,0,0),g=t.take().eventDriven("build/sprites/bigx.png",90,90,128,128,1,0,0,0),m=t.take().eventDriven("build/sprites/collar.png",128,128,128,128,1,0,0,0),y=t.take().eventDriven("build/sprites/check.png",90,90,128,128,1,0,0,0),w=t.take().eventDriven("build/sprites/grave.png",90,90,128,128,1,0,0,0);return r=new(window.AudioContext||window.webkitAudioContext),h=1,l=.1,c=.15,(s=r.createGain()).gain.value=.1,(a=r.createGain()).gain.value=.15,{spr_enemy:function(){return t.take().copyAttributes(e)},spr_tapIcon:function(){return t.take().copyAttributes(n)},spr_tiledGrass:function(){return t.take().copyAttributes(d)},spr_bigX:function(){return t.take().copyAttributes(g)},spr_collar:function(){return t.take().copyAttributes(m)},spr_check:function(){return t.take().copyAttributes(y)},spr_grave:function(){return t.take().copyAttributes(w)},snd_valid:new u("audio/ding",r,a),snd_error:new u("audio/error",r,a),snd_bgm:new u("audio/bgm",r,s,!0),initVolume:function(){let t;if("undefined"!=typeof Storage){try{t=JSON.parse(localStorage.getItem("nback_masterVolume"))}catch(t){console.log("Previous volume data is corrupted or missing.")}if(t||0===t)return h=t,this.setMasterVolume(t),t}return null},setMasterVolume:function(t){if(h=t,a.gain.value=.15*t,s.gain.value=.1*t,"undefined"!=typeof Storage)try{localStorage.setItem("nback_masterVolume",JSON.stringify(h))}catch(t){console.log("Error: an issue occurred when saving volume data.")}},putSpriteBack:function(e){t.putBack(e)}}}(),l=function(){const t=navigator.userAgent.toLowerCase(),e=t.indexOf("android")>-1,i=/ipad|iphone|ipod/i.test(t)&&!window.MSStream;let n,o=document.getElementById("start_button"),r=document.getElementById("gameWindow"),a=r.getContext("2d"),h=p,u=f;function l(){let t=f/p,o=document.getElementById("container"),s=document.getElementById("overlay");document.getElementById("widebar");h=window.innerHeight,u=h*t,n=document.getElementById("lives-overlay"),s.style.display="initial",s.style.position="absolute",s.style.height="8%",document.body.style.height=e||i?window.innerHeight+50+"px":window.innerHeight+"px",Math.floor(u)>window.innerWidth&&(t=p/f,u=window.innerWidth,h=u*t,s.style.height=window.innerHeight-h+"px",s.style.position="fixed"),r.style.width=u+"px",r.style.height=h+"px",o.style.width=u+"px",o.style.height=h+"px",o.style.marginLeft="-"+u/2+"px",window.setTimeout(function(){window.scrollTo(0,1)},1),w(!0)}function g(t,e,i){let n,o=t.layers,r=t;for(n=0;n<=o.length;n++)t=o[n],n===o.length&&(t=r),t.frameRate<=0||t.currentFrame>=t.frames?a.drawImage(t.image,t.width*(t.frames-1),0,t.width,t.height,e,i,t.width,t.height):a.drawImage(t.image,t.width*t.currentFrame,0,t.width,t.height,e,i,t.width,t.height)}r.width=f,r.height=p,window.addEventListener("load",l,!1),window.addEventListener("resize",function(t,e,i){let n;return function(){let o=this,r=arguments,s=i&&!n;clearTimeout(n),n=window.setTimeout(function(){n=null,i||t.apply(o,r)},e),s&&t.apply(o,r)}}(l,250,!1),!1);let y=function(){let t=0,e=d.spr_tiledGrass();return function(){g(e,0,t-p),g(e,0,t),c.accelerating()&&!c.gameOver()&&(t=(t+20)%p)}}(),w=function(){const t=d.spr_collar(),e=document.getElementById("score");let i=0,r=0;return function(s=!1){let a,h,u;if(c&&!c.started())o.style.display="block";else if(c&&(o.style.display="none",a=c.player().life,h=c.score(),(r!==h||s)&&(r=h,e.textContent="Score: "+h),i!==a||s)){for(i=a,u=0;u<n.childNodes.length;u++)n.childNodes[u]instanceof Image&&(n.removeChild(n.childNodes[u]),u--);for(u=0;u<a;u++){let e=document.createElement("img");e.src=t.image.src,e.className="life",n.appendChild(e)}}}}();return{render:function(t){let e,i,n=c.entities(),o=n.length;for(y(),w(),i=0;i<o;i++)e=n[i],a.fillStyle="#000000",null!==m&&a.fillRect(m.x,m.y,m.width,m.height),e.sprite&&((c.accelerating()||e instanceof s)&&e.sprite.update(t),e.draw&&e instanceof s?g(e.sprite,e.x+e.width/4,e.y):e.draw&&g(e.sprite,e.x,e.y))},canvas:r,isIOS:function(){return i},currentWidth:function(){return u}}}(),c=function(){let n,o,r,u,c,g,m,y,w,v,b,k,E,x,L,_,I=new i(new s(0,0,0,0,null)),S=new i(new h(0,0,0,0,null)),M=p-p/5,R=p/4,T=p-p/3,P=!1,A=!0,B=1,F=function(){const t=6;let e,i=[];for(e=0;e<t;e++)i.push(f*(e/t));return{NUM_LANES:t,getLaneByLocation:function(n){for(e=t;e>=0;e--)if(n>i[e])return e;return-1},getCenterX:function(t){return i[t]}}}(),D=function(){let e,i,n,o,r,s,a,h;let u=function(){let e,n,o=!1;switch(r){case 0:case 1:case 2:o=!0;break;case 5:case 6:case 7:i=.75*p,o=!0;break;case 20:i=p/2;break;case 35:i=p/3;break;case 80:i=.75*p;break;case 100:i=p/2;break;case 140:i=p/3;break;case 220:i=.75*p;break;case 240:i=p/2;break;case 350:i=p/3;break;default:r>350&&(i=p/5)}n=t(F.NUM_LANES),(e=S.take()).lane=n,e.x=F.getCenterX(n),e.y=-10,e.speed=20,e.invisPointY=i,e.sprite=d.spr_enemy(),e.sprite.addLayer(d.spr_grave()),e.width=e.sprite.width,e.height=e.sprite.height,e.draw=!0,e.isFake=!1,e.triggeredWave=!1,e.triggeredPause=!1,C(e),o&&s.push({lane:n,wave:r}),r++},l=function(){let o,a,h,u,l=!1;switch(r){case 0:case 1:case 2:l=!0;break;case 5:case 6:case 7:e=1,i=.75*p,l=!0;break;case 20:i=p/2;break;case 35:i=p/3;break;case 80:e=2,i=.75*p;break;case 100:i=p/2;break;case 140:i=p/3;break;case 220:e=3,i=.75*p;break;case 240:i=p/2;break;case 350:i=p/3;break;default:r>350&&(i=p/5)}for(h=t(F.NUM_LANES-e),u=0;u<=e;u++)(o=S.take()).lane=h+u,o.x=F.getCenterX(h+u),o.y=-10,o.speed=20,o.invisPointY=i,o.sprite=d.spr_enemy(),o.width=o.sprite.width,o.height=o.sprite.height,o.draw=!1,o.isFake=!0,o.triggeredWave=!1,o.triggeredPause=!1,n[u]=o,C(o);(a=n[t(n.length)]).isFake=!1,a.draw=!0,l&&s.push({lane:a.lane,wave:r}),r++};return{init:function(){e=0,n=[],o=0,r=0,s=[],a=0,i=2*p,h=A?u:l},updateWavesPassed:function(){o++},showTutorial:function(){if(a<s.length&&s[a].wave===o){let t;(t=I.take()).x=F.getCenterX(s[a++].lane),t.y=M,t.sprite=d.spr_tapIcon(),t.width=t.sprite.width,t.height=t.sprite.height,C(t)}},spawn:function(){h()},wavesPassed:function(){return o}}}();function O(){y=!y}function N(){m=!m}function C(t){t instanceof a?c=t:t instanceof h&&r.push(t),n.push(t)}function W(t){let i,o,a=t.length;if(0!==a){for(i=a-1;i>=0;i--){let a,h,u=t[i];if(null!==u.sprite){for(h=u.sprite.layers,o=0;o<h.length;o++)d.putSpriteBack(h[i]);d.putSpriteBack(u.sprite)}(a=n.indexOf(u))>=0&&e(n,a),(a=r.indexOf(u))>=0&&(e(r,a),S.putBack(u)),u instanceof s&&I.putBack(u)}t.includes(c)&&(c=void 0)}}function H(){v=!v}let G=function(){const t=1500;let e,i=!1,n=0,o=3;function r(){B=1,n=0,o=3,i=!1,console.log("Multiplier reset to 1.")}return{start:function(){i=!0,e=window.setTimeout(r,t)},stop:function(){i&&(window.clearTimeout(e),i=!1,1==(n=(n+1)%o)&&(o+=2,B+=.5,console.log(B+"x multipler!")))},reset:r}}();return{start:function(){if(n&&W(n),n=[],r=[],u=[],o=[],b=!1,m=!0,y=!1,w=!1,v=!1,x=0,L=0,g=0,D.init(),"undefined"!=typeof Storage){try{_=JSON.parse(localStorage.getItem("nback_scores"))}catch(t){_=[]}null===_&&(_=[])}C(c=new a(-100,-100,null)),D.spawn(),P||(P=!0,k=this.update.bind(this),E&&window.cancelAnimationFrame(E),window.requestAnimationFrame(k))},update:function(t){let e,i,r,a=!1,c=n.length,d=Math.min((t-g)/1e3,.05);if(g=t,b)return l.render(d),P=!1,void(E=window.requestAnimationFrame(k));for(r=0;r<c;r++)i=(e=n[r]).invisPointY-R,m&&e.update(d),e instanceof h&&e.y>=T&&!e.clicked&&u.indexOf(e)<0&&u.push(e),e.y>p?(o.push(e),e instanceof h&&!e.isFake&&y&&O()):e instanceof h&&(e.isFake||A)&&e.y>=i&&e.y<e.invisPointY?e.draw=!e.draw:e instanceof h&&(e.isFake||A)&&e.y>=e.invisPointY&&(e.draw=!A),e instanceof h&&!e.isFake&&e.y>=R&&!e.triggeredWave&&(D.spawn(),e.triggeredWave=!0),m&&!y&&e instanceof h&&e.y>=M&&!e.triggeredPause&&(a=!0,e.triggeredPause=!0),w&&e instanceof s&&o.push(e);a&&(N(),O(),D.showTutorial(),H(),G.start()),w&&(w=!1),W(o),o.length=0,l.render(d),window.requestAnimationFrame(k)},setGameOver:function(){var t;b||(b=!0,t=Math.round(x),_.push(t),_.sort(function(t,e){return e-t}),_=_.slice(0,10),"undefined"!=typeof Storage&&localStorage.setItem("nback_scores",JSON.stringify(_)))},addScore:function(t){(L=(x+=t*B+L)%1)>0&&(x-=L)},toggleAcceleration:N,toggleInputBuffer:O,setInputEventFired:function(){w=!0},lanes:F,addEntity:C,clickZone:T,updateWavesPassed:D.updateWavesPassed,toggleInput:H,inputTimer:G,singleSpawning:A,easyAccuracy:!1,stoppingThreshold:M,inputEnabled:function(){return v},accelerating:function(){return m},inputBuffered:function(){return y},started:function(){return P},gameOver:function(){return b},entities:function(){return n},enemies:function(){return r},player:function(){return c},frontRowEnemies:function(){return u},score:function(){return x}}}();let g=32,m=new n(-1*g,-1*g,g,g+10),y=null,w=null;function v(t){if(!c.started())return;let e,i,n,o,r=c.clickZone,s=null,a=c.frontRowEnemies(),h=c.player(),u=a.length,l=0,p=0;if("touchstart"===t.type?e=b(t.changedTouches[0]):"mousedown"===t.type&&(e=b(t)),!c.gameOver()&&h&&c.inputEnabled()&&e.y>=r){for(m.x=e.x-g/2,m.y=e.y-g/2,c.easyAccuracy&&(m.x=c.lanes.getCenterX(c.lanes.getLaneByLocation(e.x)),m.y=c.stoppingThreshold,m.height=64,m.width=1),n=0;n<u;n++)(l=(o=(i=a[n]).collisionRect()).intersection(m).getArea())>p&&(p=l,i.clicked=!0,s=i);p>0&&(c.toggleInput(),s.isFake?(s.sprite=d.spr_bigX(),h.loseLife(),c.inputTimer.reset(),d.snd_error.play()):(s.sprite=d.spr_check(),h.addLife(),c.inputTimer.stop(),d.snd_valid.play()),c.setInputEventFired(),c.accelerating()?c.inputBuffered()||c.toggleInputBuffer():c.toggleAcceleration(),a.length=0,c.updateWavesPassed())}}function b(t){let e=l.currentWidth()/f;return{x:(t.pageX-function(t){let e=0;do{isNaN(t.offsetLeft)||(e+=t.offsetLeft),t=t.offsetParent}while(null!==t);return e}(l.canvas))/e,y:(t.pageY-function(t){let e=0;do{isNaN(t.offsetTop)||(e+=t.offsetTop),t=t.offsetParent}while(null!==t);return e}(l.canvas))/e}}function k(t,e){let i=e.value;i=Number(i),l.isIOS()&&(i<=0?(i=1,e.value="1"):(i=0,e.value="0")),t.innerHTML=i<=0?"volume_mute":"volume_up",d.setMasterVolume(i)}l.canvas.addEventListener("touchstart",function(t){"mousedown"===y?Date.now()-w>1e3&&(y=t.type,w=Date.now(),v(t)):(y=t.type,w=Date.now(),v(t))}),l.canvas.addEventListener("mousedown",function(t){"touchstart"===y?Date.now()-w>1e3&&(y=t.type,w=Date.now(),v(t)):(y=t.type,w=Date.now(),v(t))});let E=document.querySelector("#overlay-volume~.slider"),x=document.querySelector("#widebar-volume~.slider"),L=document.querySelector("#overlay-volume+label>i"),_=document.querySelector("#widebar-volume+label>i");document.getElementById("overlay-volume").checked=!1,document.getElementById("widebar-volume").checked=!1,E.addEventListener("mouseup",function(t){k(L,E)}),x.addEventListener("mouseup",function(t){k(_,x)}),l.isIOS()?(E.style.visibility="hidden",x.style.visibility="hidden",L.addEventListener("touchend",function(t){t.preventDefault(),k(L,E)}),_.addEventListener("touchend",function(t){t.preventDefault(),k(_,x)})):(E.addEventListener("touchend",function(t){t.preventDefault(),k(L,E)}),x.addEventListener("touchend",function(t){t.preventDefault(),k(_,x)})),document.getElementById("start_button").addEventListener("click",function(){d.snd_bgm.play(),c.start()}),document.body.addEventListener("touchmove",function(t){t.preventDefault()},{passive:!1}),window.addEventListener("load",function(){let t=d.initVolume();0===t?(L.innerHTML="volume_mute",_.innerHTML="volume_mute"):t&&(L.innerHTML="volume_up",_.innerHTML="volume_up"),document.getElementById("container").style.display="block"},!1)}();