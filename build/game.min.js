!function(){"use strict";function t(t){return Math.floor(Math.random()*Math.floor(t))}function e(t,e){e>=t.length?console.error("ERROR: mutableRemoveIndex: index is out of range"):t.length<=0?console.error("ERROR: mutableRemoveIndex: empty array"):(t[e]=t[t.length-1],t[t.length-1]=void 0,t.length=t.length-1)}function i(t){this.template=t,this.pool=[]}function n(t,e,i,n){this.x=t,this.y=e,this.width=i,this.height=n}function o(t,e,i,n,o){this.width=e,this.height=i,this.frames=n,this.frameRate=o,this.timer=0,this.currentFrame=0,this.image=t,this.animationEndEvent=null}function r(t,e,i,o,r){this.x=t,this.y=e,this.time=0,this.draw=!0,this.width=i,this.height=o,this.sprite=r,this.hitbox=new n(this.x-this.width/2,this.y-this.height/2,this.width,this.height)}function s(t,e,i,n,o){r.call(this,t,e,i,n,o)}function a(t,e,i){r.call(this,t,e,40,40,i),this.rangeOfMovement=4,this.maxLife=3,this.life=this.maxLife}function h(t,e,i,n,o){r.call(this,t,e,40,40,o),this.invisPointY=n,this.speed=i,this.isFake=!1,this.lane=1,this.triggeredWave=!1,this.triggeredPause=!1}let u,c,l;i.prototype.take=function(){let t,e;for(e=0;e<this.pool.length;e++)if(this.pool[e].available)return this.pool[e].available=!1,this.pool[e].object.init(),this.pool[e].object;return(t=this.template.clone()).init(),this.pool.push({available:!1,object:t}),t},i.prototype.putBack=function(t){let e;for(e=0;e<this.pool.length;e++)if(this.pool[e].object===t){this.pool[e].available=!0;break}},n.prototype.left=function(){return this.x},n.prototype.right=function(){return this.x+this.width},n.prototype.top=function(){return this.y},n.prototype.bottom=function(){return this.y+this.height},n.prototype.intersects=function(t){return this.right()>=t.left()&&this.left()<=t.right()&&this.top()<=t.bottom()&&this.bottom()>=t.top()},n.prototype.contains=function(t,e){return this.left()<=t&&t<=this.right()&&this.bottom()<=e&&e<=this.top()},n.prototype.union=function(t){let e,i,n,o;void 0!==t&&(e=Math.min(this.x,t.x),i=Math.min(this.y,t.y),n=Math.max(this.right(),t.right())-Math.min(this.left(),t.left()),o=Math.max(this.bottom(),t.bottom())-Math.min(this.top(),t.top()),this.x=e,this.y=i,this.width=n,this.height=o)},o.prototype.eventDriven=function(t,e,i,n,o,r,s,a,h){let u=document.createElement("img"),c=document.createElement("img");return u.addEventListener("load",function t(){let s=document.createElement("canvas"),l=s.getContext("2d");s.width=e*r,s.height=i,l.drawImage(u,h*n,a*o,n*r,o,0,0,e*r,i),c.src=s.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frames=r,this.frameRate=s,this.timer=0,this.currentFrame=0,this.image=c,this.animationEndEvent=null,this},o.prototype.tiled=function(t,e,i,n,o,r,s,a,h){let u=document.createElement("img"),c=document.createElement("img");return u.addEventListener("load",function t(){let l,p,f=document.createElement("canvas"),d=f.getContext("2d");for(f.width=e,f.height=i,l=0;l<a;l++)for(p=0;p<h;p++)d.drawImage(u,s*n,r*o,n,o,l*e/a,p*i/h,e/a,i/h);c.src=f.toDataURL("image/png"),u.removeEventListener("load",t)},!1),u.src=t,this.width=e,this.height=i,this.frameRate=0,this.frames=1,this.timer=0,this.currentFrame=0,this.image=c,this},o.prototype.resetAnimation=function(){this.currentFrame=0},o.prototype.update=function(t){this.frameRate>0&&(this.timer+=t,this.timer>1/this.frameRate&&(this.timer=0,this.currentFrame++,this.currentFrame>this.frames-1&&null!==this.animationEndEvent&&this.animationEndEvent()))},o.prototype.init=function(){this.width=0,this.height=0,this.frameRate=0,this.frames=0,this.currentFrame=0,this.timer=0,this.image=null,this.animationEndEvent=null},o.prototype.clone=function(){return new o(this.image,this.width,this.height,this.frames,this.frameRate)},o.prototype.copyAttributes=function(t){return this.width=t.width,this.height=t.height,this.frameRate=t.frameRate,this.frames=t.frames,this.image=t.image,this.animationEndEvent=t.animationEndEvent,this},r.prototype.init=function(){this.x=0,this.y=0,this.time=0,this.draw=!0,this.sprite=null},r.prototype.clone=function(){return new r(this.x,this.y,this.width,this.height,this.sprite)},r.prototype.update=function(t){this.time+=t},r.prototype.collisionRect=function(){return this.hitbox.x=this.x,this.hitbox.y=this.y,this.hitbox.width=this.width,this.hitbox.height=this.height,this.hitbox},r.prototype.collisionLine=function(){return this.hitbox.x=this.x-this.width/2,this.hitbox.y=this.y-this.height/2,this.hitbox.width=this.width,this.hitbox.height=1,this.hitbox},r.prototype.isCollidingWith=function(t){let e=this.collisionRect(),i=t.collisionRect();return e.intersects(i)},s.prototype=Object.create(r.prototype),s.prototype.init=function(){r.prototype.init.call(this)},s.prototype.clone=function(){return new s(this.x,this.y,this.width,this.height,this.sprite)},a.prototype=Object.create(r.prototype),a.prototype.update=function(t){r.prototype.update.call(this,t),c.addScore(1)},a.prototype.addLife=function(){this.life+=1,this.life>=this.maxLife&&(this.life=this.maxLife)},a.prototype.loseLife=function(){this.life-=1,this.life<=0&&c.setGameOver()},a.prototype.move=function(t,e){this.x=t,this.y=e},h.prototype=Object.create(r.prototype),h.prototype.init=function(){r.prototype.init.call(this),this.invisPointY=0,this.speed=0,this.lane=1,this.isFake=!1,this.triggeredWave=!1,this.triggeredPause=!1},h.prototype.clone=function(){return new h(this.x,this.y,this.speed,this.invisPointY,this.sprite)},h.prototype.update=function(t){r.prototype.update.call(this,t),this.y+=this.speed};const p=720,f=480;l=function(){let t=new i(new o(null,0,0,0,0)),e=t.take().eventDriven("build/sprites/animals.png",60,60,26,36,1,0,4,7),n=t.take().eventDriven("build/sprites/explosion.png",60,60,223,174,21,21,0,0),r=t.take().eventDriven("build/sprites/tap.png",75,76,75,76,2,3,0,0);r.animationEndEvent=r.resetAnimation;let s=t.take().tiled("build/sprites/grassland.png",f,p,128,128,4,6,4,10),a=t.take().eventDriven("build/sprites/bigx.png",45,60,239,299,1,0,0,0),h=t.take().eventDriven("build/sprites/collar.png",128,128,1024,1024,1,0,0,0);return{spr_enemy:function(){return t.take().copyAttributes(e)},spr_explosion:function(){return t.take().copyAttributes(n)},spr_tapIcon:function(){return t.take().copyAttributes(r)},spr_tiledGrass:function(){return t.take().copyAttributes(s)},spr_bigX:function(){return t.take().copyAttributes(a)},spr_collar:function(){return t.take().copyAttributes(h)},putSpriteBack:function(e){t.putBack(e)}}}(),u=function(){let t=document.querySelector("#lives"),e=0,i=document.querySelector("#gameWindow"),n=i.getContext("2d"),o=p,r=f;function a(){const t=f/p,e=navigator.userAgent.toLowerCase(),n=e.indexOf("android")>-1,s=e.indexOf("iphone")>-1||e.indexOf("ipad")>-1;let a=document.querySelector(".container");o=window.innerHeight,r=o*t,(n||s)&&(document.body.style.height=window.innerHeight+50+"px"),i.style.width=r+"px",i.style.height=o+"px",a.style.width=r+"px",a.style.height=o+"px",window.setTimeout(function(){window.scrollTo(0,1)},1)}function h(t,e,i){t.frameRate<=0||t.currentFrame>=t.frames?n.drawImage(t.image,t.width*(t.frames-1),0,t.width,t.height,e,i,t.width,t.height):n.drawImage(t.image,t.width*t.currentFrame,0,t.width,t.height,e,i,t.width,t.height)}i.width=f,i.height=p,a(),window.addEventListener("resize",function(t,e,i){let n;return function(){let o=this,r=arguments,s=i&&!n;clearTimeout(n),n=setTimeout(function(){n=null,i||t.apply(o,r)},e),s&&t.apply(o,r)}}(a,250,!1),!1);let u=function(){let t=0,e=l.spr_tiledGrass();return function(){h(e,0,t-p),h(e,0,t),c.accelerating()&&!c.gameOver()&&(t+=20),t>=p&&(t=0)}}();return{render:function(i){let o,r,a=c.entities();for(u(),function(){let i,n=c.player().life;if(c.started()?c.started()&&(t.style.display="flex"):t.style.display="none",e!==n){for(e=n;t.hasChildNodes();)t.removeChild(t.firstChild);for(i=0;i<n;i++){let e=document.createElement("img");e.src=l.spr_collar().image.src,t.appendChild(e)}}}(),r=0;r<a.length;r++)o=a[r],null!==d&&n.fillRect(d.x,d.y,d.width,d.height),(c.accelerating()||o instanceof s)&&o.sprite.update(i),o.draw&&o instanceof s?h(o.sprite,o.x,o.y):o.draw&&h(o.sprite,o.x-o.width/4,o.y-o.height/2)},GAME_FIELD_WIDTH:f,GAME_FIELD_HEIGHT:p,canvas:i,currentWidth:function(){return r}}}(),c=function(){let n,o,r,c,d,g,m,y,w,v,x,b,E,k,L=new i(new s(0,0,0,0,null)),F=new i(new h(0,0,0,0,null)),R=20,A=p-p/5,P=p/4,_=!1,S=!0,O=document.querySelector("#start_button"),D=function(){const t=6;let e,i=[];for(e=1;e<=t;e++)i.push(f*(e/t));return{NUM_LANES:t,getLaneByLocation:function(n){for(e=0;e<t;e++)if(n<i[e])return e;return-1},getCenterX:function(e){return f/t*e+20}}}(),I=function(){let e,i,n,o;return{init:function(){e=0,n=0,o=[],i=2*p},spawn:function(){let r,s,a,h;switch(console.log(n),n){case 5:e=1,i=.75*p;break;case 20:e=2;break;case 35:i=p/2;break;case 60:e=3;break;case 90:i=p/3;break;case 120:e=4;break;case 160:i=p/4}for(a=t(D.NUM_LANES-e),h=0;h<=e;h++)(r=F.take()).lane=a+h,r.x=D.getCenterX(a+h),r.y=-10,r.speed=R,r.invisPointY=i,r.sprite=l.spr_enemy(),r.draw=!1,r.isFake=!0,r.triggeredWave=!1,r.triggeredPause=!1,o[h]=r,C(r);return(s=o[t(o.length)]).isFake=!1,s.draw=!0,s.lane},updateWavesPassed:function(){n++},wavesPassed:function(){return n}}}();function M(){m=!m}function B(){g=!g}function C(t){t instanceof a?c=t:t instanceof h&&r.push(t),n.push(t)}function W(t){let i;if(0!==t.length){for(i=0;i<t.length;i++){let o,a=t[i];null!==a.sprite&&l.putSpriteBack(a.sprite),(o=n.indexOf(a))>=0&&e(n,o),(o=r.indexOf(a))>=0&&(e(r,o),F.putBack(a)),a instanceof s&&L.putBack(a)}t.includes(c)&&(c=void 0)}}return{start:function(){if(n&&W(n),n=[],r=[],o=[],v=[],w=!1,g=!0,m=!1,y=!1,E=0,d=0,I.init(),O.style.display="none","undefined"!=typeof Storage)try{k=JSON.parse(localStorage.nBackScores)}catch(t){k=[]}c=new a(-100,-100,null),v.push(I.spawn()),_||(_=!0,x=this.update.bind(this),b&&window.cancelAnimationFrame(b),window.requestAnimationFrame(x))},update:function(t){let e,i,r,a=!1,c=I.wavesPassed(),f=Math.min((t-d)/1e3,.05);if(d=t,w)return _=!1,u.render(f),void(b=window.requestAnimationFrame(x));for(r=0;r<n.length;r++){if(i=(e=n[r]).invisPointY-P,g&&e.update(f),e.y>p?(o.push(e),e instanceof h&&!e.isFake&&(I.updateWavesPassed(),m&&M())):e instanceof h&&e.isFake&&e.y>=i&&e.y<e.invisPointY?e.draw=!e.draw:e instanceof h&&e.isFake&&e.y>=e.invisPointY&&(e.draw=!0),S){let t;0<=c&&c<=2&&g&&!m&&e instanceof h&&e.y>=A&&!e.triggeredPause?(a=!0,e.triggeredPause=!0,(t=L.take()).x=D.getCenterX(v[c]),t.y=A,t.sprite=l.spr_tapIcon(),t.width=t.sprite.width,t.height=t.sprite.height,C(t)):c>=3&&(S=!1)}else g&&!m&&e instanceof h&&e.y>=A&&!e.triggeredPause&&(a=!0,e.triggeredPause=!0);if(e instanceof h&&!e.isFake&&e.y>=P&&!e.triggeredWave){let t=I.spawn();e.triggeredWave=!0,S&&v.push(t)}y&&e instanceof s&&o.push(e)}a&&(B(),M()),y&&(y=!1),W(o),o.length=0,u.render(f),window.requestAnimationFrame(x)},setGameOver:function(){var t;w||(w=!0,O.style.display="block",t=Math.round(E),k.push(t),k.sort(function(t,e){return e-t}),k=k.slice(0,10),"undefined"!=typeof Storage&&(localStorage.nBackScores=JSON.stringify(k)),console.log(k))},addScore:function(t){E+=t},toggleAcceleration:B,toggleInputBuffer:M,setInputEventFired:function(){y=!0},lanes:D,addEntity:C,accelerating:function(){return g},inputBuffered:function(){return m},started:function(){return _},gameOver:function(){return w},entities:function(){return n},enemies:function(){return r},player:function(){return c}}}();let d=new n(-30,-30,30,30),g=p-p/3,m=null,y=null;function w(t){let e,i,n,o=c.player();if("touchstart"===t.type?e=v(t.changedTouches[0]):"mousedown"===t.type&&(e=v(t)),!c.gameOver()&&o&&e.y>=g)for(d.x=e.x-5,d.y=e.y-5,n=0;n<c.enemies().length;n++)(i=c.enemies()[n]).draw&&i.collisionRect().intersects(d)&&(i.isFake?(i.sprite=l.spr_bigX(),o.loseLife()):(i.sprite=l.spr_explosion(),o.addLife()),c.setInputEventFired(),c.accelerating()?c.inputBuffered()||c.toggleInputBuffer():c.toggleAcceleration())}function v(t){let e=u.currentWidth()/f;return{x:(t.pageX-function(t){let e=0;do{isNaN(t.offsetLeft)||(e+=t.offsetLeft),t=t.offsetParent}while(null!==t);return e}(u.canvas))/e,y:(t.pageY-function(t){let e=0;do{isNaN(t.offsetTop)||(e+=t.offsetTop),t=t.offsetParent}while(null!==t);return e}(u.canvas))/e}}u.canvas.addEventListener("touchstart",function(t){"mousedown"===m?Date.now()-y>5e3&&(m=t.type,y=Date.now(),w(t)):(m=t.type,y=Date.now(),w(t))}),u.canvas.addEventListener("mousedown",function(t){"touchstart"===m?Date.now()-y>5e3&&(m=t.type,y=Date.now(),w(t)):(m=t.type,y=Date.now(),w(t))}),document.querySelector("#start_button").addEventListener("click",function(){c.start()})}();